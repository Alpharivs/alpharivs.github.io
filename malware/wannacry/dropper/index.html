<!doctype html><html lang=en dir=ltr><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Wannacry - Part 1 | Lux-Sit</title><meta name=generator content="Hugo Eureka 0.9.3"><link rel=stylesheet href=https://alpharivs.github.io/css/eureka.min.9cec6350e37e534b0338fa9a085bf06855de3b0f2dcf857e792e5e97b07ea905d4d5513db554cbc26a9c3da622bae92d.css><script defer src=https://alpharivs.github.io/js/eureka.min.fa9a6bf6d7a50bb635b4cca7d2ba5cf3dfb095ae3798773f1328f7950028b48c17d06276594e1b5f244a25a6c969a705.js></script>
<link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=preload href="https://fonts.googleapis.com/css2?family=Lora:wght@400;600;700&family=Noto+Serif+SC:wght@400;600;700&display=swap" as=style onload='this.onload=null,this.rel="stylesheet"'><link rel=stylesheet href=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/styles/base16/solarized-light.min.css media=print onload='this.media="all",this.onload=null' crossorigin><script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/highlight.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/dart.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/bash.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/cpp.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/python.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/c.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/vbscript.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/powershell.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/http.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/x86asm.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/go.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/javascript.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/ruby.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/php.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/shell.min.js crossorigin></script>
<link rel=stylesheet href=https://alpharivs.github.io/css/highlightjs.min.2958991528e43eb6fc9b8c4f2b8e052f79c4010718e1d1e888a777620e9ee63021c2c57ec7417a3108019bb8c41943e6.css media=print onload='this.media="all",this.onload=null'><script defer type=text/javascript src=https://alpharivs.github.io/js/fontawesome.min.5326b5f9c61e2373bd99194e0e41377b1e5e42801f5fc0f2a11fe5ac898837b5e0e86b52e854fc435c595e22ec6a61b1.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css integrity=sha384-MlJdn/WNKDGXveldHDdyRP1R4CTHr3FeuDNfhsLPYrq2t0UBkUdK2jyTnXPEK1NQ media=print onload='this.media="all",this.onload=null' crossorigin><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js integrity=sha384-VQ8d8WVFw0yHhCk5E8I86oOhv48xLpnDZx5T9GogA/Y84DcCKWXDmSDfn13bzFZY crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin></script>
<script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}]})})</script><script defer src=https://cdn.jsdelivr.net/npm/mermaid@8.14.0/dist/mermaid.min.js integrity=sha384-atOyb0FxAgN9LyAc6PEf9BjgwLISyansgdH8/VXQH8p2o5vfrRgmGIJ2Sg22L0A0 crossorigin></script>
<link rel=icon type=image/png sizes=32x32 href=https://alpharivs.github.io/images/icon_hu4bae09c78eba04c5e7d71d1040233379_73006_32x32_fill_q75_box_center.jpg><link rel=apple-touch-icon sizes=180x180 href=https://alpharivs.github.io/images/icon_hu4bae09c78eba04c5e7d71d1040233379_73006_180x180_fill_q75_box_center.jpg><meta name=description content="Analyzing the Dropper."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://alpharivs.github.io/malware/"},{"@type":"ListItem","position":2,"name":"Wannacry - Part 1","item":"https://alpharivs.github.io/malware/wannacry/dropper/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://alpharivs.github.io/malware/wannacry/dropper/"},"headline":"Wannacry - Part 1 | Lux-Sit","image":"https://alpharivs.github.io/images/malware/WannaCry.jpg","datePublished":"2022-11-08T00:00:00+00:00","dateModified":"2022-11-08T00:00:00+00:00","wordCount":1564,"author":{"@type":"Person","name":"Alpharivs"},"publisher":{"@type":"Person","name":"WANG Chucheng","logo":{"@type":"ImageObject","url":"https://alpharivs.github.io/images/icon.jpg"}},"description":"Analyzing the Dropper."}</script><meta property="og:title" content="Wannacry - Part 1 | Lux-Sit"><meta property="og:type" content="article"><meta property="og:image" content="https://alpharivs.github.io/images/icon.jpg"><meta property="og:url" content="https://alpharivs.github.io/malware/wannacry/dropper/"><meta property="og:description" content="Analyzing the Dropper."><meta property="og:locale" content="en"><meta property="og:site_name" content="Lux-Sit"><meta property="article:published_time" content="2022-11-08T00:00:00+00:00"><meta property="article:modified_time" content="2022-11-08T00:00:00+00:00"><meta property="article:section" content="malware"><meta property="article:tag" content="malware"><meta property="article:tag" content="analysis"><meta property="article:tag" content="static"><meta property="article:tag" content="dynamic"><meta property="article:tag" content="reversing"><meta property="article:tag" content="dropper"><meta property="og:see_also" content="https://alpharivs.github.io/malware/lab-setup-guide/"><body class="flex min-h-screen flex-col"><header class="min-h-16 pl-scrollbar bg-secondary-bg fixed z-50 flex w-full items-center shadow-sm"><div class="mx-auto w-full max-w-screen-xl"><script>let storageColorScheme=localStorage.getItem("lightDarkMode");((storageColorScheme=="Auto"||storageColorScheme==null)&&window.matchMedia("(prefers-color-scheme: dark)").matches||storageColorScheme=="Dark")&&document.getElementsByTagName("html")[0].classList.add("dark")</script><nav class="flex items-center justify-between flex-wrap px-4 py-4 md:py-0"><a href=/ class="me-6 text-primary-text text-xl font-bold">Lux-Sit</a>
<button id=navbar-btn class="md:hidden flex items-center px-3 py-2" aria-label="Open Navbar">
<i class="fas fa-bars"></i></button><div id=target class="hidden block md:flex md:grow md:justify-between md:items-center w-full md:w-auto text-primary-text z-20"><div class="md:flex md:h-16 text-sm md:grow pb-4 md:pb-0 border-b md:border-b-0"><a href=/malware/ class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 selected-menu-item me-4">Malware Analysis</a>
<a href=/writeups/ class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 border-transparent me-4">CTF Write-ups</a>
<a href=/htb_writeups/ class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 border-transparent me-4">HacktheBox Write-ups</a></div><div class=flex><div class="relative pt-4 md:pt-0"><div class="cursor-pointer hover:text-eureka" id=lightDarkMode><i class="fas fa-adjust"></i></div><div class="fixed hidden inset-0 opacity-0 h-full w-full cursor-default z-30" id=is-open></div><div class="absolute flex flex-col start-0 md:start-auto end-auto md:end-0 hidden bg-secondary-bg w-48 rounded py-2 border border-tertiary-bg cursor-pointer z-40" id=lightDarkOptions><span class="px-4 py-1 hover:text-eureka" name=Light>Light</span>
<span class="px-4 py-1 hover:text-eureka" name=Dark>Dark</span>
<span class="px-4 py-1 hover:text-eureka" name=Auto>Auto</span></div></div></div></div><div class="fixed hidden inset-0 opacity-0 h-full w-full cursor-default z-0" id=is-open-mobile></div></nav><script>let element=document.getElementById("lightDarkMode");storageColorScheme==null||storageColorScheme=="Auto"?document.addEventListener("DOMContentLoaded",()=>{window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",switchDarkMode)}):storageColorScheme=="Light"?(element.firstElementChild.classList.remove("fa-adjust"),element.firstElementChild.setAttribute("data-icon","sun"),element.firstElementChild.classList.add("fa-sun")):storageColorScheme=="Dark"&&(element.firstElementChild.classList.remove("fa-adjust"),element.firstElementChild.setAttribute("data-icon","moon"),element.firstElementChild.classList.add("fa-moon")),document.addEventListener("DOMContentLoaded",()=>{getcolorscheme(),switchBurger()})</script></div></header><main class="grow pt-16"><div class=pl-scrollbar><div class="mx-auto w-full max-w-screen-xl lg:px-4 xl:px-8"><div class="grid grid-cols-2 gap-4 lg:grid-cols-8 lg:pt-12"><div class="bg-secondary-bg col-span-2 rounded px-6 py-8 lg:col-span-6"><article class=prose><h1 class=mb-4>Wannacry - Part 1</h1><div class="text-tertiary-text not-prose mt-2 flex flex-row flex-wrap items-center"><div class="me-6 my-2"><i class="fas fa-calendar me-1"></i>
<span>2022-11-08</span></div><div class="me-6 my-2"><i class="fas fa-clock me-1"></i>
<span>8 min read</span></div><div class="me-6 my-2"><i class="fas fa-folder me-1"></i>
<a href=https://alpharivs.github.io/categories/malware/ class=hover:text-eureka>malware</a></div></div><img src=https://alpharivs.github.io/images/malware/WannaCry.jpg class=w-full alt="Featured Image"><h2 id=introduction>Introduction</h2><p>We will be analyzing a sample of the infamous ransomware &ldquo;wannacry&rdquo; and it&rsquo;s behavior and effects in our system, this is not meant to be an analysis of it&rsquo;s cryptographic functions nor a complete reverse engineering of the malware.</p><p>We must remember that our objective as malware analysts is to provide information needed to detect, prevent and contain further intrusions that means determining exactly what happened and detecting all the infected machines and examining suspicious files in order to generate useful host/network based signatures to detect and prevent infections in our systems, when falling into a rabbit hole of reverse engineering one must remember what our main objective as analysts is.</p><h2 id=sample-details>Sample Details</h2><table><thead><tr><th>Hashes</th><th></th></tr></thead><tbody><tr><td>md5</td><td>DB349B97C37D22F5EA1D1841E3C89EB4</td></tr></tbody></table><p>Detection Results:
<img src=images/v_total.png alt=v_total></p><h2 id=tools-used>Tools Used</h2><pre><code class=language-text>- VirtualBox
- pedump
- die (Detect it Easy)
- PEstudio
- ida64
- Ghidra
- Regshot
- Procmon
- Autoruns
- Process Hacker
- x32dbg
- fakeDNS
- InetSim
- Caffeine
</code></pre><h2 id=basic-static-analysis>Basic Static Analysis</h2><p>Let&rsquo;s begin by doing some basic analysis of the PE to see what can we learn examining it&rsquo;s headers and section data.</p><h3 id=pe-properties>PE Properties</h3><pre><code class=language-text>remnux@remnux:~/malware/wannacry$ file wannacry.exe
wannacry.exe: PE32 executable (GUI) Intel 80386, for MS Windows
</code></pre><p>The PE has some suspicious resources embedded in it so it&rsquo;s worth checking them out.</p><pre><code class=language-text>=== SECTIONS ===
(...snip...)
  .rsrc      310000   35a454   35b000    32000     0        0     0        0  40000040  R-- IDATA

=== RESOURCES ===
FILE_OFFSET    CP  LANG     SIZE  TYPE          NAME
    0x320a4  1252 0x409  3514368  R             #1831
    0x38c0a4  1252 0x409      944  VERSION       #1
</code></pre><p>As seen in the image below the resource named &ldquo;1831&rdquo; is clearly another PE as it has the then PE file signature (hex 4d 5a, ascii MZ) and the DOS stub.
<img src=images/resource.png alt=resource></p><h3 id=import-table-analysis>Import Table Analysis</h3><p>The PE is not packed as imports are visible and numerous this allows us to make some educated guesses of it&rsquo;s functionality without resorting to dynamic analysis.</p><h4 id=interesting-and-suspicious-imports>Interesting and Suspicious Imports</h4><pre><code class=language-text>ADVAPI32.dll - StartServiceCtrlDispatcherA - Locating this function in malware tells that the function should be run as a service.
ADVAPI32.dll - OpenSCManagerA - Any program that installs,modifies, or controls a service must call this function before any other service-manipulation function.
ADVAPI32.dll - CreateServiceA - Malware uses CreateService for persistence, stealth, or to load kernel drivers.
ADVAPI32.dll - CryptAcquireContextA - Initializes the use of Windows encryption.
KERNEL32.dll - CreateFileA
KERNEL32.dll - LoadResource - Loads a resource from a PE file into memory. 
KERNEL32.dll - FindResourceA
KERNEL32.dll - GetProcAddress - Used to import functions from other DLLs in addition to the functions imported in the PE file header.
KERNEL32.dll - GetModuleHandleW - Locate and modify code in a loaded module or to search for a good location to inject code.
KERNEL32.dll - GetModuleFileNameA - Malware can use this function to modify or copy files in the currently running process.
KERNEL32.dll - GetTickCount - Sometimes used to gather timing information as an anti-debugging technique but is often added by the compiler.
</code></pre><p>The imports above already give us a hint of the malware&rsquo;s functionality, we can predict that it creates and starts a service, deals with encryption in some way, loads a resource and dynamically load some other functions that we can&rsquo;t currently see but are probably related to dropping the payload i.e. WriteFile</p><p>With that information and the fact that there&rsquo;s a PE in the resource section it wouldn&rsquo;t be wild to say that it&rsquo;s functionality is to drop a payload somewhere in the targeted box.</p><h4 id=networking-capabilities>Networking Capabilities</h4><p>Based on the imported DLLs we see that the malware has Low-Level networking capabilities i.e. opening sockets.</p><pre><code class=language-text>- 3 (closesocket)	ws2_32.dll
- 16 (recv)	ws2_32.dll
- 19 (send)	ws2_32.dll
- 8 (htonl)	ws2_32.dll
- 14 (ntohl)	ws2_32.dll
- 115 (WSAStartup)	ws2_32.dll
- 12 (inet_ntoa)	ws2_32.dll
- 10 (ioctlsocket)	ws2_32.dll
- 18 (select)	ws2_32.dll
- 9 (htons)	ws2_32.dll
- 23 (socket)	ws2_32.dll
- 4 (connect)	ws2_32.dll
- 11 (inet_addr)	ws2_32.dll
</code></pre><p>and it has also high-level capabilities , high-level capabilities have the advantage of blending in with regular traffic but the disadvantage that the User-Agent header must be manually provided providing us with the opportunity of extracting a potential network indicator for our detection signatures.</p><pre><code class=language-text>WININET.dll - InternetOpenA	User-Agent, Initializes the high-level Internet access functions from WinINet,
WININET.dll - InternetOpenUrlA
</code></pre><h3 id=strings>Strings</h3><p>Analyzing the strings can algo give us very good indicators and hints for the functionality of the malware.</p><p>We can see some strings related to the worm functionality of the malware which is accomplished using MS17-010 codename &lsquo;Eternal Blue&rsquo;</p><pre><code class=language-text>SMBr
PC NETWORK PROGRAM 1.0
LANMAN1.0
Windows for Workgroups 3.1a
LM1.2X002
LANMAN2.1
NT LM 0.12
SMBs
Windows 2000 2195
Windows 2000 5.0
SMBu
__USERID__PLACEHOLDER__@
\\172.16.99.5\IPC$
__TREEID__PLACEHOLDER__
__USERID__PLACEHOLDER__@
SMB3
__TREEID__PLACEHOLDER__
__USERID__PLACEHOLDER__@
\t
SMB3
__TREEID__PLACEHOLDER__
__USERID__PLACEHOLDER__@
userid
treeid
__TREEPATH_REPLACE__
\\%s\IPC$
</code></pre><p>We can also see some crypto related strings, arguments, paths, and dynamically loaded functions</p><pre><code class=language-text>Microsoft Base Cryptographic Provider v1.0
%d.%d.%d.%d
mssecsvc2.0
Microsoft Security Center (2.0) Service
%s -m security
C:\%s\qeriuwjhrf
C:\%s\%s
WINDOWS
tasksche.exe
CloseHandle
WriteFile
CreateFileA
CreateProcessA
32.dll
</code></pre><p>And a weird url.</p><pre><code class=language-text>http://www.iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea.com
</code></pre><p>All those strings give us some really indicators that we can use to build up out detection signatures.</p><h2 id=dynamic-analysis>Dynamic Analysis</h2><p>Having performed a basic static analysis now it&rsquo;s time to see what this piece of malware does in action.</p><h3 id=killswitch-on>Killswitch On</h3><p>If we setup an internal network and redirect all dns queries to a machine that we control (as seen below using fakedns, and inetsim) we immediately see a query to the strange URL that we found earlier</p><pre><code class=language-bash>remnux@remnux:~/malware/wannacry$ fakedns
fakedns[INFO]: dom.query. 60 IN A 10.10.10.2
fakedns[INFO]: Response: www[.]iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea[.]com -&gt; 10.10.10.2

Inetsim report:
2022-11-08 14:48:48  HTTP connection, method: GET, URL: hxxp[://]www[.]iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea[.]com/
</code></pre><p>Interestingly that seems to prevent the malware from executing any further let&rsquo;s try to see whats going on under the hood.</p><p>A quick way to reach the part of the code that makes the request is to search for the Xrefs to InternetOpenA. (which we know is being used based on our analysis)
<img src=images/kill_search.png alt=kill_search></p><p>That leads us to a function that ida64 has labeled WinMain, where we can see that our suspicious url being loaded as a parameter.
<img src=images/kill_function.png alt=kill_function></p><p>We can see the result of InterOpenUrlA being copied into the edi register which then is checked to see if it&rsquo;s value is 0.
<img src=images/kill_code.png alt=kill_code></p><p>InternetOpenUrlA returns a valid handle to the URL if the connection is successfully established, or NULL if the connection fails, so if the URL is found the value will be non 0 which means that the program is going to jump to loc_4081BC where we will meet a dead end in order to take the other path the URL must be unreachable so that function 408090 will be called.</p><h3 id=killswitch-off>Killswitch Off</h3><h4 id=running-the-malware>Running the Malware</h4><p>After making sure that the URL will not be reached the malware now after running wht malware we can see the following hellscape where our beloved files will be now encrypted, our wallpaper changed and a truly obnoxious window with the payment instructions has been spawned.
<img src=images/post_encryption.png alt=post_encryption></p><h4 id=dropping-the-payload>Dropping the Payload</h4><p>Procmon reports that the WriteFile operation has been called by wannacry.exe.</p><pre><code class=language-text>wannacry.exe WriteFile C:\Windows\taskche.exe
</code></pre><p>The WriteFile function was dynamically loaded as we can see in the image below, that&rsquo;s why we couldn&rsquo;t see it before.</p><p><img src=images/loading_functions.png alt=loading_functions></p><p>and then it&rsquo;s being called to write tasksche.exe to the disk as seen below.</p><p><img src=images/write_resource.png alt=write_resource></p><p>Examining the call to WriteFile with x32dbg we can analyze what and where it writes, the second argument (eax register) is the the executable found in the resource section (shown in the dump) and the fourth argument (edx register shown below in the stack) is the location and name in which it will be written.</p><h4 id=registry-changes>Registry Changes</h4><p>Using RegShot we can get check the registry for modifications.</p><table><thead><tr><th>Key</th><th>Value</th></tr></thead><tbody><tr><td>HKLM\SYSTEM\ControlSet001\Services\mssecsvc2.0</td><td>C:\Users\Euryale\Desktop\wannacry.exe -m security</td></tr><tr><td>HKLM\SYSTEM\ControlSet001\Services\wcjlbgmjfcfjhcv579</td><td>cmd.exe /c &ldquo;C:\ProgramData\wcjlbgmjfcfjhcv579\tasksche.exe&rdquo;</td></tr></tbody></table><p>It seems that a service has been created which is set up to run the dropper with the argument &ldquo;-m security&rdquo;, we already guessed that based on the imports and we can confirm it by quickly debugging the PE and checking how it calls CreateService as seen below.</p><p><img src=images/service_creation.png alt=service_creation></p><p>Wen can also see a value added to &ldquo;CurrentVersion\Run" which is a common way in which malware achieves persistence.
NOTE: We will later examine when analyzing the payload where that weird &ldquo;wcjlbgmjfcfjhcv579&rdquo; comes from.\</p><pre><code class=language-text>----------------------------------
Values added: 47
----------------------------------
HKLM\SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\Run\wcjlbgmjfcfjhcv579: &quot;&quot;C:\ProgramData\wcjlbgmjfcfjhcv579\tasksche.exe&quot;&quot;
</code></pre><p>Quickly checking autoruns confirms that indeed the malware achieves persistence by these means.
<img src=images/persistence.png alt=persistence></p><p>We can even see evidence of how it changed our beautiful wallpaper.</p><pre><code>HKU\S-1-5-21-125203715-1897566060-139690607-1001\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\Wallpapers\BackgroundHistoryPath0: &quot;C:\Users\Euryale\Desktop\@WanaDecryptor@.bmp&quot;
</code></pre><h4 id=running-processes>Running Processes</h4><p>Checking the running processes we can see the following.
<img src=images/process_running.png alt=process_running></p><p>Using Procmon we see that the dropper started the tasksche.exe process.
<img src=images/run_payload_arg.png alt=run_payload_arg>
the process was launched with the /i argument, which could pretty mean install.</p><p>and we can also see that the dropper launched itself with the &ldquo;-m security&rdquo; argument by starting the process that it previously created.</p><p><img src=images/worm.png alt=worm></p><h3 id=worm-functionality--m-security>Worm Functionality (-m security)</h3><p>The malware launches itself using the &ldquo;-m security&rdquo; argument which is a way of self propagation via SMB, while the analysis of this functionality is out of scope of this post <a href=https://www.mcafee.com/blogs/other-blogs/mcafee-labs/analysis-wannacry-ransomware/>this</a> article explains how it leverages Eternal Blue in order to propagate through the network.</p><h2 id=conclusion>Conclusion</h2><p>With this we conclude the analysis of this piece of malware, we should now have some understanding of how it delivers it&rsquo;s embedded payload, the changes and artifacts that it leaves in infected systems and of how it propagates through the network.</p><p>In the next post we will analyze the &ldquo;tasksche.exe&rdquo; PE and solve some mysteries left like the weird random name and what does the /i argument does.</p><p><a href=/malware/wannacry/launcher/>Link to Part - 2</a></p><p>Lux-Sit</p></article><div class=my-4><a href=https://alpharivs.github.io/tags/malware/ class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 me-2 hover:text-eureka">#malware</a>
<a href=https://alpharivs.github.io/tags/analysis/ class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 me-2 hover:text-eureka">#analysis</a>
<a href=https://alpharivs.github.io/tags/static/ class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 me-2 hover:text-eureka">#static</a>
<a href=https://alpharivs.github.io/tags/dynamic/ class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 me-2 hover:text-eureka">#dynamic</a>
<a href=https://alpharivs.github.io/tags/reversing/ class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 me-2 hover:text-eureka">#reversing</a>
<a href=https://alpharivs.github.io/tags/dropper/ class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 me-2 hover:text-eureka">#dropper</a>
<a href=https://alpharivs.github.io/tags/wannacry/ class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 me-2 hover:text-eureka">#wannacry</a></div><div class=py-2><div class="my-8 flex flex-col items-center md:flex-row"><a href=https://alpharivs.github.io/authors/alpharivs/ class="md:me-4 text-primary-text h-24 w-24"><img src=https://alpharivs.github.io/images/profile.jpg class="bg-primary-bg w-full rounded-full" alt=Avatar></a><div class="mt-4 w-full md:mt-0 md:w-auto"><a href=https://alpharivs.github.io/authors/alpharivs/ class="mb-2 block border-b pb-1 text-lg font-bold"><h3>Alpharivs</h3></a><span class="block pb-2">Eternal Cybersecurity student with love for Malware and CTFs</span>
<a href=mailto:caliburn@tutanota.de class=me-2><i class="fas fa-envelope"></i></a>
<a href=https://twitter.com/alpharivs class=me-2><i class="fab fa-twitter"></i></a>
<a href=https://github.com/Alpharivs class=me-2><i class="fab fa-github"></i></a>
<a href=https://app.hackthebox.com/users/525385 class=me-2><i class="fab fa-jedi-order"></i></a></div></div></div><div class="-mx-2 mt-4 flex flex-col border-t px-2 pt-4 md:flex-row md:justify-between"><div><span class="text-primary-text block font-bold">Previous</span>
<a href=https://alpharivs.github.io/malware/wannacry/launcher/ class=block>Wannacry - Part 2</a></div><div class="mt-4 md:mt-0 md:text-right"><span class="text-primary-text block font-bold">Next</span>
<a href=https://alpharivs.github.io/malware/lab-setup-guide/ class=block>Malware Analysis Network Setup Guide</a></div></div></div><div class=col-span-2><div class="bg-primary-bg
prose sticky top-16 z-10 hidden px-6 py-4 lg:block"><h3>On This Page</h3></div><div class="sticky-toc hidden px-6 pb-6 lg:block"><nav id=TableOfContents><ul><li><a href=#introduction>Introduction</a></li><li><a href=#sample-details>Sample Details</a></li><li><a href=#tools-used>Tools Used</a></li><li><a href=#basic-static-analysis>Basic Static Analysis</a><ul><li><a href=#pe-properties>PE Properties</a></li><li><a href=#import-table-analysis>Import Table Analysis</a><ul><li><a href=#interesting-and-suspicious-imports>Interesting and Suspicious Imports</a></li><li><a href=#networking-capabilities>Networking Capabilities</a></li></ul></li><li><a href=#strings>Strings</a></li></ul></li><li><a href=#dynamic-analysis>Dynamic Analysis</a><ul><li><a href=#killswitch-on>Killswitch On</a></li><li><a href=#killswitch-off>Killswitch Off</a><ul><li><a href=#running-the-malware>Running the Malware</a></li><li><a href=#dropping-the-payload>Dropping the Payload</a></li><li><a href=#registry-changes>Registry Changes</a></li><li><a href=#running-processes>Running Processes</a></li></ul></li><li><a href=#worm-functionality--m-security>Worm Functionality (-m security)</a></li></ul></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></div><script>window.addEventListener("DOMContentLoaded",()=>{enableStickyToc()})</script></div><div class="bg-secondary-bg prose col-span-2 rounded p-6 lg:col-span-6"><h3>See Also</h3><a href=https://alpharivs.github.io/malware/lab-setup-guide/ class=no-underline>Malware Analysis Network Setup Guide</a><br></div></div><script>document.addEventListener("DOMContentLoaded",()=>{hljs.highlightAll()})</script></div></div></main><footer class=pl-scrollbar><div class="mx-auto w-full max-w-screen-xl"><div class="text-center p-6 pin-b"><p class="text-sm text-tertiary-text">&copy; 2022 <a href=https://twitter.com/alpharivs>Alpharivs</a>
&#183; Powered by the <a href=https://github.com/wangchucheng/hugo-eureka class=hover:text-eureka>Eureka</a> theme for <a href=https://gohugo.io class=hover:text-eureka>Hugo</a></p></div></div></footer></body></html>