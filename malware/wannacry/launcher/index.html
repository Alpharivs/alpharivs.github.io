<!doctype html><html lang=en dir=ltr><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Wannacry - Part 2 | Lux-Sit</title><meta name=generator content="Hugo Eureka 0.9.3"><link rel=stylesheet href=https://alpharivs.github.io/css/eureka.min.9cec6350e37e534b0338fa9a085bf06855de3b0f2dcf857e792e5e97b07ea905d4d5513db554cbc26a9c3da622bae92d.css><script defer src=https://alpharivs.github.io/js/eureka.min.fa9a6bf6d7a50bb635b4cca7d2ba5cf3dfb095ae3798773f1328f7950028b48c17d06276594e1b5f244a25a6c969a705.js></script>
<link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=preload href="https://fonts.googleapis.com/css2?family=Lora:wght@400;600;700&family=Noto+Serif+SC:wght@400;600;700&display=swap" as=style onload='this.onload=null,this.rel="stylesheet"'><link rel=stylesheet href=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/styles/base16/solarized-light.min.css media=print onload='this.media="all",this.onload=null' crossorigin><script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/highlight.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/dart.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/bash.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/cpp.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/python.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/c.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/vbscript.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/powershell.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/http.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/x86asm.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/go.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/javascript.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/ruby.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/php.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/shell.min.js crossorigin></script>
<link rel=stylesheet href=https://alpharivs.github.io/css/highlightjs.min.2958991528e43eb6fc9b8c4f2b8e052f79c4010718e1d1e888a777620e9ee63021c2c57ec7417a3108019bb8c41943e6.css media=print onload='this.media="all",this.onload=null'><script defer type=text/javascript src=https://alpharivs.github.io/js/fontawesome.min.5326b5f9c61e2373bd99194e0e41377b1e5e42801f5fc0f2a11fe5ac898837b5e0e86b52e854fc435c595e22ec6a61b1.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css integrity=sha384-MlJdn/WNKDGXveldHDdyRP1R4CTHr3FeuDNfhsLPYrq2t0UBkUdK2jyTnXPEK1NQ media=print onload='this.media="all",this.onload=null' crossorigin><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js integrity=sha384-VQ8d8WVFw0yHhCk5E8I86oOhv48xLpnDZx5T9GogA/Y84DcCKWXDmSDfn13bzFZY crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin></script>
<script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}]})})</script><script defer src=https://cdn.jsdelivr.net/npm/mermaid@8.14.0/dist/mermaid.min.js integrity=sha384-atOyb0FxAgN9LyAc6PEf9BjgwLISyansgdH8/VXQH8p2o5vfrRgmGIJ2Sg22L0A0 crossorigin></script>
<link rel=icon type=image/png sizes=32x32 href=https://alpharivs.github.io/images/icon_hu4bae09c78eba04c5e7d71d1040233379_73006_32x32_fill_q75_box_center.jpg><link rel=apple-touch-icon sizes=180x180 href=https://alpharivs.github.io/images/icon_hu4bae09c78eba04c5e7d71d1040233379_73006_180x180_fill_q75_box_center.jpg><meta name=description content="Analyzing the Launcher."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://alpharivs.github.io/malware/"},{"@type":"ListItem","position":2,"name":"Wannacry - Part 2","item":"https://alpharivs.github.io/malware/wannacry/launcher/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://alpharivs.github.io/malware/wannacry/launcher/"},"headline":"Wannacry - Part 2 | Lux-Sit","image":"https://alpharivs.github.io/images/malware/WannaCry.jpg","datePublished":"2022-11-14T00:00:00+00:00","dateModified":"2022-11-14T00:00:00+00:00","wordCount":1888,"author":{"@type":"Person","name":"Alpharivs"},"publisher":{"@type":"Person","name":"WANG Chucheng","logo":{"@type":"ImageObject","url":"https://alpharivs.github.io/images/icon.jpg"}},"description":"Analyzing the Launcher."}</script><meta property="og:title" content="Wannacry - Part 2 | Lux-Sit"><meta property="og:type" content="article"><meta property="og:image" content="https://alpharivs.github.io/images/icon.jpg"><meta property="og:url" content="https://alpharivs.github.io/malware/wannacry/launcher/"><meta property="og:description" content="Analyzing the Launcher."><meta property="og:locale" content="en"><meta property="og:site_name" content="Lux-Sit"><meta property="article:published_time" content="2022-11-14T00:00:00+00:00"><meta property="article:modified_time" content="2022-11-14T00:00:00+00:00"><meta property="article:section" content="malware"><meta property="article:tag" content="malware"><meta property="article:tag" content="analysis"><meta property="article:tag" content="static"><meta property="article:tag" content="dynamic"><meta property="article:tag" content="reversing"><meta property="article:tag" content="wannacry"><meta property="og:see_also" content="https://alpharivs.github.io/malware/wannacry/dropper/"><meta property="og:see_also" content="https://alpharivs.github.io/malware/lab-setup-guide/"><body class="flex min-h-screen flex-col"><header class="min-h-16 pl-scrollbar bg-secondary-bg fixed z-50 flex w-full items-center shadow-sm"><div class="mx-auto w-full max-w-screen-xl"><script>let storageColorScheme=localStorage.getItem("lightDarkMode");((storageColorScheme=="Auto"||storageColorScheme==null)&&window.matchMedia("(prefers-color-scheme: dark)").matches||storageColorScheme=="Dark")&&document.getElementsByTagName("html")[0].classList.add("dark")</script><nav class="flex items-center justify-between flex-wrap px-4 py-4 md:py-0"><a href=/ class="me-6 text-primary-text text-xl font-bold">Lux-Sit</a>
<button id=navbar-btn class="md:hidden flex items-center px-3 py-2" aria-label="Open Navbar">
<i class="fas fa-bars"></i></button><div id=target class="hidden block md:flex md:grow md:justify-between md:items-center w-full md:w-auto text-primary-text z-20"><div class="md:flex md:h-16 text-sm md:grow pb-4 md:pb-0 border-b md:border-b-0"><a href=/malware/ class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 selected-menu-item me-4">Malware Analysis</a>
<a href=/writeups/ class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 border-transparent me-4">CTF Write-ups</a>
<a href=/htb_writeups/ class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 border-transparent me-4">HacktheBox Write-ups</a></div><div class=flex><div class="relative pt-4 md:pt-0"><div class="cursor-pointer hover:text-eureka" id=lightDarkMode><i class="fas fa-adjust"></i></div><div class="fixed hidden inset-0 opacity-0 h-full w-full cursor-default z-30" id=is-open></div><div class="absolute flex flex-col start-0 md:start-auto end-auto md:end-0 hidden bg-secondary-bg w-48 rounded py-2 border border-tertiary-bg cursor-pointer z-40" id=lightDarkOptions><span class="px-4 py-1 hover:text-eureka" name=Light>Light</span>
<span class="px-4 py-1 hover:text-eureka" name=Dark>Dark</span>
<span class="px-4 py-1 hover:text-eureka" name=Auto>Auto</span></div></div></div></div><div class="fixed hidden inset-0 opacity-0 h-full w-full cursor-default z-0" id=is-open-mobile></div></nav><script>let element=document.getElementById("lightDarkMode");storageColorScheme==null||storageColorScheme=="Auto"?document.addEventListener("DOMContentLoaded",()=>{window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",switchDarkMode)}):storageColorScheme=="Light"?(element.firstElementChild.classList.remove("fa-adjust"),element.firstElementChild.setAttribute("data-icon","sun"),element.firstElementChild.classList.add("fa-sun")):storageColorScheme=="Dark"&&(element.firstElementChild.classList.remove("fa-adjust"),element.firstElementChild.setAttribute("data-icon","moon"),element.firstElementChild.classList.add("fa-moon")),document.addEventListener("DOMContentLoaded",()=>{getcolorscheme(),switchBurger()})</script></div></header><main class="grow pt-16"><div class=pl-scrollbar><div class="mx-auto w-full max-w-screen-xl lg:px-4 xl:px-8"><div class="grid grid-cols-2 gap-4 lg:grid-cols-8 lg:pt-12"><div class="bg-secondary-bg col-span-2 rounded px-6 py-8 lg:col-span-6"><article class=prose><h1 class=mb-4>Wannacry - Part 2</h1><div class="text-tertiary-text not-prose mt-2 flex flex-row flex-wrap items-center"><div class="me-6 my-2"><i class="fas fa-calendar me-1"></i>
<span>2022-11-14</span></div><div class="me-6 my-2"><i class="fas fa-clock me-1"></i>
<span>9 min read</span></div><div class="me-6 my-2"><i class="fas fa-folder me-1"></i>
<a href=https://alpharivs.github.io/categories/malware/ class=hover:text-eureka>malware</a></div></div><img src=https://alpharivs.github.io/images/malware/WannaCry.jpg class=w-full alt="Featured Image"><h2 id=introduction>Introduction</h2><p>In this part of the Wannacry malware analysis we will have a look at the launcher that is dropped by the malware component that we analyzed in <a href=/malware/wannacry/dropper/>part - 1</a></p><h2 id=sample-details>Sample Details</h2><table><thead><tr><th>Name</th><th></th></tr></thead><tbody><tr><td>tasksche.exe</td><td></td></tr></tbody></table><table><thead><tr><th>Hashes</th><th></th></tr></thead><tbody><tr><td>md5</td><td>84c82835a5d21bbcf75a61706d8ab549</td></tr></tbody></table><p>Detection Results:
<img src=images/resource_v_total.png alt=resource_v_total></p><p>Now let&rsquo;s just verify that tasksche.exe is actually the same resource that we first saw when performing the static analysis.</p><pre><code class=language-bash>pedump wannacry.exe --extract resource:0x320a4 &gt; resource.exe

md5sum resource.exe
84c82835a5d21bbcf75a61706d8ab549  resource.exe
</code></pre><pre><code class=language-text>PS C:\Users\Euryale\Desktop&gt; Get-FileHash -Alg MD5 .\tasksche.exe

Algorithm       Hash                                                                   Path
---------       ----                                                                   ----
MD5             84C82835A5D21BBCF75A61706D8AB549
</code></pre><p>As we can see the both executables are indeed the same.</p><h2 id=basic-static-analysis>Basic Static Analysis</h2><p>Let&rsquo;s begin performing a basic static analysis of the malware.</p><h3 id=pe-properties>PE Properties</h3><pre><code class=language-text>remnux@remnux:~/malware/wannacry$ file wannacry.exe
wannacry.exe: PE32 executable (GUI) Intel 80386, for MS Windows
</code></pre><p>The PE has some suspicious resources embedded in it so it&rsquo;s worth checking them out.</p><pre><code class=language-text>=== SECTIONS ===
(...snip...)
  .rsrc       10000   349fa0   34a000    10000     0        0     0        0  40000040  R-- IDATA

=== RESOURCES ===
FILE_OFFSET    CP  LANG     SIZE  TYPE          NAME
  0x100f0   1252  0x409  3446325   XIA            #2058
  0x359728  1252  0x409      904   VERSION        #1
  0x359ab0  1252  0x409     1263   MANIFEST       #1
</code></pre><p>We also have a resource named &ldquo;2058&rdquo; but this time we can see it&rsquo;s a ZIP archive based on the file signature (hex 50 4b, ascii PK)</p><p>If we try to extract it and unzip it&rsquo;s contents we see that it&rsquo;s password protected.
<img src=images/payload_resource.png alt=payload_resource></p><h3 id=import-table-analysis>Import Table Analysis</h3><p>The PE is also not packed and has visible imports.</p><h4 id=interesting-and-suspicious-imports>Interesting and Suspicious Imports</h4><pre><code class=language-text>KERNEL32.dll      3a4        WriteFile
KERNEL32.dll      1d6        GetTempPathW
KERNEL32.dll      1f4        GetWindowsDirectoryW
KERNEL32.dll      355        SizeofResource
KERNEL32.dll      265        LockResource
KERNEL32.dll      257        LoadResource
KERNEL32.dll       e3        FindResourceA
KERNEL32.dll      284        OpenMutexA - Creates a mutual exclusion object to ensure that only a single instance of the malware is running.
KERNEL32.dll      17d        GetModuleFileNameA - Can be used to modify or copy files in the currently running process.
KERNEL32.dll      1b7        GetStartupInfoA - Retrieves a structure containing details about how the current process was configured to run.
KERNEL32.dll      31f        SetFileTime - Can be used for timestomping
KERNEL32.dll      252        LoadLibraryA - Loads a DLL into a process that may not have been loaded when the program started.
KERNEL32.dll      1a0        GetProcAddress - Retrieves the address of a function in a DLL loaded into memory.
KERNEL32.dll       66        CreateProcessA

ADVAPI32.dll      1ad        OpenSCManagerA
ADVAPI32.dll       64        CreateServiceA
ADVAPI32.dll      1af        OpenServiceA
ADVAPI32.dll      249        StartServiceA
ADVAPI32.dll       a0        CryptReleaseContext
ADVAPI32.dll      1d3        RegCreateKeyW
ADVAPI32.dll      204        RegSetValueExA
ADVAPI32.dll      1f7        RegQueryValueExA
ADVAPI32.dll      1cb        RegCloseKey
</code></pre><p>This time it seems that it doesn&rsquo;t have any network functionalities although they could be dynamically loaded using LoadLibraryA.</p><h3 id=strings>Strings</h3><p>We have an extension list which we can assume filters which files to encrypt.</p><pre><code class=language-text>.der .pfx .key .crt .csr .p12 .pem .odt .ott .sxw .stw .uot .3ds .max .3dm .ods .ots .sxc .stc .dif .slk .wb2 .odp .otp .sxd .std .uop .odg .otg .sxm .mml .lay .lay6 .asc .sqlite3 .sqlitedb .sql .accdb .mdb .db .dbf .odb .frm .myd .myi .ibd .mdf .ldf .sln .suo .cs .c .cpp .pas .h .asm .js .cmd .bat .ps1 .vbs .vb .pl .dip .dch .sch .brd .jsp .php .asp .rb .java .jar .class .sh .mp3 .wav .swf .fla .wmv .mpg .vob .mpeg .asf .avi .mov .mp4 .3gp .mkv .3g2 .flv .wma .mid .m3u .m4u .djvu .svg .ai .psd .nef .tiff .tif .cgm .raw .gif .png .bmp .jpg .jpeg .vcd .iso .backup .zip .rar .7z .gz .tgz .tar .bak .tbk .bz2 .PAQ .ARC .aes .gpg .vmx .vmdk .vdi .sldm .sldx .sti .sxi .602 .hwp .snt .onetoc2 .dwg .pdf .wk1 .wks .123 .rtf .csv .txt .vsdx .vsd .edb .eml .msg .ost .pst .potm .potx .ppam .ppsx .ppsm .pps .pot .pptm .pptx .ppt .xltm .xltx .xlc .xlm .xlt .xlw .xlsb .xlsm .xlsx .xls .dotx .dotm .dot .docm .docb .docx .doc
</code></pre><p>Some paths and commands</p><pre><code class=language-text>%s\\%s
%s\\Intel
%s\\ProgramData
cmd.exe /c \&quot;%s\&quot;
icacls . /grant Everyone:F /T /C /Q
attrib +h .
</code></pre><p>What seems to be Bitcoin addresses</p><pre><code class=language-text>115p7UMMngoj1pMvkpHijcRdfJNXj6LrLn
12t9YDPgwueZ9NyMgw519p7AA8isjr6SMw
13AM4VW2dhxYgXeQepoHkHSQuy6NgaEb94
</code></pre><p>A mutex name along with other file names.</p><pre><code class=language-text>%s%d
Global\\MsWinZonesCacheCounterMutexA
tasksche.exe
WANACRY!
XIA
TaskStart
t.wnry
WNcry@2ol7
</code></pre><h2 id=dynamic-analysis>Dynamic Analysis</h2><h3 id=the-mysterious-i-argument>The mysterious /i argument</h3><p>The malware is first run by the dropper using the /i argument so let&rsquo;s examine it&rsquo;s behavior when running with said argument.</p><h4 id=randomly-named-hidden-folder>Randomly Named Hidden Folder</h4><p>We can quickly see that tasksche.exe is responsible for the creation of the weird folder name that we previously detected as seen in the image below.</p><p><img src=images/create_random_dir.png alt=create_random_dir></p><p>Turns out it&rsquo;s a random named based on the computer name that means that it can&rsquo;t be used as a signature but it&rsquo;s worth knowing how it&rsquo;s generated, we can see in the image below how the malware calls GetComputerNameW and then proceeds to generate a random string with the returned result</p><p><img src=images/random_name_code.png alt=random_name_code></p><p>Then there&rsquo;s a check to see if the argument /i is provided, if it is present it will proceed to call function 00401af6 which based on the calls it makes creates a new directory, sets it&rsquo;s attributes to hidden and changes the CWD into the new directory.</p><p><img src=images/create_dir_graph.png alt=create_dir_graph></p><p>which we can confirm is the directory with the random name inside the ProgramData directory, NOTE: if the creation in ProgramData fails the malware will try to create the file inside the following locations:</p><table><thead><tr><th>Main Path</th><th>Alternate Path</th></tr></thead><tbody><tr><td>C:\ProgramData\</td><td>C:\Windows\ProgramData\</td></tr><tr><td>C:\Intel\</td><td>C:\Windows\Intel\</td></tr><tr><td>C:\</td><td></td></tr></tbody></table><p>In our case C:\ProgramData was successful as seen in the image below</p><p><img src=images/create_dir_params.png alt=create_dir_params></p><p>And then it will copy itself into that directory.</p><p><img src=images/random_copy.png alt=random_copy></p><h4 id=service-creation>Service Creation</h4><p>The malware will then proceed to install itself as a service providing it&rsquo;s new path.</p><p><img src=images/taskche_service_install.png alt=tasksche_service_install></p><p>We saw that in <a href=/malware/wannacry/dropper/>part - 1</a> when looking for registry changes.</p><pre><code class=language-text>----------------------------------
Values added: 47
----------------------------------
HKLM\SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\Run\wcjlbgmjfcfjhcv579: &quot;&quot;C:\ProgramData\wcjlbgmjfcfjhcv579\tasksche.exe&quot;&quot;
HKLM\SOFTWARE\WOW6432Node\WanaCrypt0r\wd: &quot;C:\ProgramData\wcjlbgmjfcfjhcv579&quot;
</code></pre><p>We previously concluded that it&rsquo;s used to achieve persistance.</p><h4 id=mutex-creation>Mutex Creation</h4><p>Then it will check for a Mutex to see if there&rsquo;s another instance running.</p><p><img src=images/mutex_check.png alt=mutex_check></p><h4 id=process-creation>Process Creation</h4><p>And finally it will run itself but this time without any argument.</p><p><img src=images/create_process.png alt=create_process></p><h3 id=no-argument>No Argument</h3><p>When running itself without an argument it changes the CWD to the random name folder.</p><p>Then it creates a registry entry for WanaCrypt0r pointing to the binary in our CWD.</p><pre><code class=language-bash>HKLM\SOFTWARE\WOW6432Node\WanaCrypt0r\wd: &quot;C:\ProgramData\wcjlbgmjfcfjhcv579&quot;
</code></pre><h4 id=extracting-zipped-resources>Extracting Zipped Resources</h4><p>The next function &lsquo;.text:004020D0&rsquo; takes a string &ldquo;WNcry@2ol7&rdquo; as an argument and loads the embedded zip archive and then calls a function.</p><p><img src=images/zip_extract.png alt=zip_extract></p><p>By tracing the string shown below we find out that the function unzips the resource.</p><pre><code class=language-text>.rdata:0040D455	0000002A	C	unzip 0.15 Copyright 1998 Gilles Vollant&quot;
</code></pre><p>The function loads the resource and using the string as password unzips the contents of the archive, we can confirm that several files have been created in the random name directory.</p><p>Here&rsquo;s a brief overview of the extracted files without entering in much details for the sake of brevity:</p><table><thead><tr><th>Name</th><th>Function</th></tr></thead><tbody><tr><td>msg</td><td>Directory containing instructions in multiple languages</td></tr><tr><td>taskdl.exe</td><td>Cleans temporary files</td></tr><tr><td>taskse.exe</td><td>Enumerates RDP sessions and executes tasksche.exe in each session</td></tr><tr><td>b.wnry</td><td>The wallpaper that the malware sets</td></tr><tr><td>c.wnry</td><td>Configuration file that included the C2 onion addresses and the Bitcoin addresses</td></tr><tr><td>r.wnry</td><td>Ransom message</td></tr><tr><td>s.wnry</td><td>ZIP archive containing the Tor Browser PE</td></tr><tr><td>t.wnry</td><td>Encrypted DLL which we will later on analyze</td></tr></tbody></table><h4 id=selecting-a-random-bitcoin-address-and-writing-it-to-cwinry>Selecting a Random Bitcoin Address and Writing it to c.winry</h4><p>Next the malware calls a function that contains three bitcoin addresses:</p><p><img src=images/bitcoin_config.png alt=bitcoin_config></p><p>First it checks if c.winry exists calling a function that can read or write c.winry, in this case it is called passing &ldquo;1&rdquo; as &ldquo;arg_4&rdquo; so it jumps into read mode ,it&rsquo;s a check to see if it exists.</p><p><img src=images/c.winry_check.png alt=c.winry_check></p><p>And then it selects a random Bitcoin address which it then writes into c.winry by calling the previous function this time passing &ldquo;0&rdquo; as &ldquo;arg_4&rdquo;.</p><p><img src=images/bitcoin_select.png alt=bitcoin_select></p><h4 id=hiding-and-changing-directory-attributes>Hiding and Changing Directory Attributes.</h4><p>Now the malware will hide the randomly named directory, give full access to all users of the infected system and dynamically load a bunch of external functions.</p><p><img src=images/attribs.png alt=attribs></p><h4 id=decrypting-and-running-twinry>Decrypting and running t.winry</h4><p>The next functions are quite interesting.</p><p>First the malware loads a RSA key, it checks if an external file containing a RSA key is provided and if it&rsquo;s not it loads an embedded RSA key.</p><p><img src=images/load_or_read_key.png alt=load_or_read_key></p><p>In the next function call the malware opens t.winry in read mode, get&rsquo;s it&rsquo;s size and then compares the first 8 bits of it&rsquo;s content with the string &ldquo;WANACRY!&rdquo;</p><p><img src=images/compare_t.winry.png alt=compare_t.winry></p><p>Finally the malware decrypts the contents of t.winry with the loaded or imported RSA key, we know that because the argument &ldquo;var_2C&rdquo; can be traced to the return value of the function that loads the RSA key and afterwards there are a a bunch of encryption related functions that are being called (that can be identified by looking for encryption constants).</p><p><img src=images/decrypt_dll.png alt=decrypt_dll></p><p>The last 2 functions load the decrypted DLL calling a function named &ldquo;TaskStart&rdquo;.</p><p><img src=images/dll_taskstart.png alt=dll_taskstart></p><h2 id=extraction-and-overview-of-the-decrypted-dll>Extraction and Overview of the Decrypted DLL</h2><p>While a detailed analysis of how the encryption function of the malware works (initiated by the decrypted DLL) is not in scope of this post we will extract it and make a brief overview of it&rsquo;s functionality.</p><p>One way of extracting the decrypted dll is using x32dbg by doing the following"</p><ul><li>Place a breakpoint in the function that decrypts t.winry and step over.</li><li>Follow the returned value which is stored in the eax register into dump.</li><li>Follow the dump into the memory map.</li><li>Dump the selected memory to file.</li></ul><p><img src=images/dump_dll.png alt=dump_dll></p><p>That should give us a workable sample of the decrypted t.winry DLL.</p><pre><code class=language-shell>remnux@remnux:~/malware/wannacry$ file t.winry.dll
t.winry.dll: PE32 executable (DLL) (GUI) Intel 80386, for MS Windows
</code></pre><h3 id=taskstart-function>TaskStart Function</h3><p>When can confirm that the DLL exports the TaskStart function by looking at it&rsquo;s exports.</p><p><img src=images/exports.png alt=exports></p><p>The first call that this function makes creates the mutex &ldquo;MsWinZonesCacheCounterMutexA&rdquo;, then it proceeds to set the the CWD to the directory in which the DLL is located and it checks if the configuration file (c.winry) exists then it checks if we are running as &ldquo;system&rdquo;.</p><p><img src=images/system_check.png alt=system_check></p><p>Then malware then creates the following strings:</p><table><thead><tr><th>Name</th><th>Use</th></tr></thead><tbody><tr><td>00000000.res</td><td>C2 data</td></tr><tr><td>00000000.eky</td><td>Victim-unique RSA private key encrypted with embedded RSA public key</td></tr><tr><td>00000000.pky</td><td>RSA-2048 public key</td></tr><tr><td>00000000.dky</td><td>Decrypted RSA private key (00000000.eky) transmitted to victim if he pays.</td></tr></tbody></table><p>The malware will then attempt to Load an perform an encryption test with 00000000.dky if the check is not successful it means we don&rsquo;t have the decrypted private RSA key (meaning we payed) and it proceeds to do the following:</p><ul><li><p>Check if it can load a key from 00000000.pky, if not it generates a RSA 2048 key pair and saves the public key in 00000000.pky which will be use to encrypt our files, the corresponding private key used to decrypt the files is stored on the 00000000.eky and encrypted with the embedded public key</p><p>The threat actors have the private key paired with the embedded public key meaning that they are the only ones that can decrypt our encrypted private key (00000000.eky) needed to decrypt our files.</p></li><li><p>Launches a thread that writes every 25 seconds the current time of the system in 00000000.res.</p></li><li><p>Launches a thread that performs an encryption and decryption test with 00000000.dky and 00000000.pky every 25 seconds stopping if it&rsquo;s successful (basically checking if we have payed).</p></li><li><p>Launches a thread that enumerates and scans for new disks on the system including removable drives and network drives and proceed to encrypt the contents of every drive it finds.</p></li><li><p>Start taskdl.exe, taskse.exe and @WanaDecryptor@.exe</p></li></ul><h2 id=conclusion>Conclusion</h2><p>And that wraps up the analysis of this piece of malware, while it was not an in depth technical analysis of it&rsquo;s encryption components we&rsquo;ve got a solid overview of it&rsquo;s functionality and we have extracted a lot of useful host and network signatures that can be used to detect, prevent and contain this piece of malware.</p><p>Lux-Sit</p></article><div class=my-4><a href=https://alpharivs.github.io/tags/malware/ class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 me-2 hover:text-eureka">#malware</a>
<a href=https://alpharivs.github.io/tags/analysis/ class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 me-2 hover:text-eureka">#analysis</a>
<a href=https://alpharivs.github.io/tags/static/ class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 me-2 hover:text-eureka">#static</a>
<a href=https://alpharivs.github.io/tags/dynamic/ class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 me-2 hover:text-eureka">#dynamic</a>
<a href=https://alpharivs.github.io/tags/reversing/ class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 me-2 hover:text-eureka">#reversing</a>
<a href=https://alpharivs.github.io/tags/wannacry/ class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 me-2 hover:text-eureka">#wannacry</a>
<a href=https://alpharivs.github.io/tags/launcher/ class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 me-2 hover:text-eureka">#launcher</a></div><div class=py-2><div class="my-8 flex flex-col items-center md:flex-row"><a href=https://alpharivs.github.io/authors/alpharivs/ class="md:me-4 text-primary-text h-24 w-24"><img src=https://alpharivs.github.io/images/profile.jpg class="bg-primary-bg w-full rounded-full" alt=Avatar></a><div class="mt-4 w-full md:mt-0 md:w-auto"><a href=https://alpharivs.github.io/authors/alpharivs/ class="mb-2 block border-b pb-1 text-lg font-bold"><h3>Alpharivs</h3></a><span class="block pb-2">Eternal Cybersecurity student with love for Malware and CTFs</span>
<a href=mailto:caliburn@tutanota.de class=me-2><i class="fas fa-envelope"></i></a>
<a href=https://twitter.com/alpharivs class=me-2><i class="fab fa-twitter"></i></a>
<a href=https://github.com/Alpharivs class=me-2><i class="fab fa-github"></i></a>
<a href=https://app.hackthebox.com/users/525385 class=me-2><i class="fab fa-jedi-order"></i></a></div></div></div><div class="-mx-2 mt-4 flex flex-col border-t px-2 pt-4 md:flex-row md:justify-between"><div><span class="text-primary-text block font-bold">Previous</span>
<a href=https://alpharivs.github.io/malware/emotet/ class=block>Emotet</a></div><div class="mt-4 md:mt-0 md:text-right"><span class="text-primary-text block font-bold">Next</span>
<a href=https://alpharivs.github.io/malware/wannacry/dropper/ class=block>Wannacry - Part 1</a></div></div></div><div class=col-span-2><div class="bg-primary-bg
prose sticky top-16 z-10 hidden px-6 py-4 lg:block"><h3>On This Page</h3></div><div class="sticky-toc hidden px-6 pb-6 lg:block"><nav id=TableOfContents><ul><li><a href=#introduction>Introduction</a></li><li><a href=#sample-details>Sample Details</a></li><li><a href=#basic-static-analysis>Basic Static Analysis</a><ul><li><a href=#pe-properties>PE Properties</a></li><li><a href=#import-table-analysis>Import Table Analysis</a><ul><li><a href=#interesting-and-suspicious-imports>Interesting and Suspicious Imports</a></li></ul></li><li><a href=#strings>Strings</a></li></ul></li><li><a href=#dynamic-analysis>Dynamic Analysis</a><ul><li><a href=#the-mysterious-i-argument>The mysterious /i argument</a><ul><li><a href=#randomly-named-hidden-folder>Randomly Named Hidden Folder</a></li><li><a href=#service-creation>Service Creation</a></li><li><a href=#mutex-creation>Mutex Creation</a></li><li><a href=#process-creation>Process Creation</a></li></ul></li><li><a href=#no-argument>No Argument</a><ul><li><a href=#extracting-zipped-resources>Extracting Zipped Resources</a></li><li><a href=#selecting-a-random-bitcoin-address-and-writing-it-to-cwinry>Selecting a Random Bitcoin Address and Writing it to c.winry</a></li><li><a href=#hiding-and-changing-directory-attributes>Hiding and Changing Directory Attributes.</a></li><li><a href=#decrypting-and-running-twinry>Decrypting and running t.winry</a></li></ul></li></ul></li><li><a href=#extraction-and-overview-of-the-decrypted-dll>Extraction and Overview of the Decrypted DLL</a><ul><li><a href=#taskstart-function>TaskStart Function</a></li></ul></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></div><script>window.addEventListener("DOMContentLoaded",()=>{enableStickyToc()})</script></div><div class="bg-secondary-bg prose col-span-2 rounded p-6 lg:col-span-6"><h3>See Also</h3><a href=https://alpharivs.github.io/malware/wannacry/dropper/ class=no-underline>Wannacry - Part 1</a><br><a href=https://alpharivs.github.io/malware/lab-setup-guide/ class=no-underline>Malware Analysis Network Setup Guide</a><br></div></div><script>document.addEventListener("DOMContentLoaded",()=>{hljs.highlightAll()})</script></div></div></main><footer class=pl-scrollbar><div class="mx-auto w-full max-w-screen-xl"><div class="text-center p-6 pin-b"><p class="text-sm text-tertiary-text">&copy; 2023 <a href=https://twitter.com/alpharivs>Alpharivs</a>
&#183; Powered by the <a href=https://github.com/wangchucheng/hugo-eureka class=hover:text-eureka>Eureka</a> theme for <a href=https://gohugo.io class=hover:text-eureka>Hugo</a></p></div></div></footer></body></html>