<!doctype html><html lang=en dir=ltr><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Flare-On 2022 - T8 | Lux-Sit</title><meta name=generator content="Hugo Eureka 0.9.3"><link rel=stylesheet href=https://alpharivs.github.io/css/eureka.min.9cec6350e37e534b0338fa9a085bf06855de3b0f2dcf857e792e5e97b07ea905d4d5513db554cbc26a9c3da622bae92d.css><script defer src=https://alpharivs.github.io/js/eureka.min.fa9a6bf6d7a50bb635b4cca7d2ba5cf3dfb095ae3798773f1328f7950028b48c17d06276594e1b5f244a25a6c969a705.js></script>
<link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=preload href="https://fonts.googleapis.com/css2?family=Lora:wght@400;600;700&family=Noto+Serif+SC:wght@400;600;700&display=swap" as=style onload='this.onload=null,this.rel="stylesheet"'><link rel=stylesheet href=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/styles/base16/solarized-light.min.css media=print onload='this.media="all",this.onload=null' crossorigin><script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/highlight.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/dart.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/bash.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/cpp.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/python.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/c.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/vbscript.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/powershell.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/http.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/x86asm.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/go.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/javascript.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/ruby.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/php.min.js crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/languages/shell.min.js crossorigin></script>
<link rel=stylesheet href=https://alpharivs.github.io/css/highlightjs.min.2958991528e43eb6fc9b8c4f2b8e052f79c4010718e1d1e888a777620e9ee63021c2c57ec7417a3108019bb8c41943e6.css media=print onload='this.media="all",this.onload=null'><script defer type=text/javascript src=https://alpharivs.github.io/js/fontawesome.min.1a0e4e36d09c9b8c79729f1a7cb90dc225c79dcc45da26e3cb870b6f0c8e7c3cddf25cf0c93dcf203138152fff75823f.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css integrity=sha384-MlJdn/WNKDGXveldHDdyRP1R4CTHr3FeuDNfhsLPYrq2t0UBkUdK2jyTnXPEK1NQ media=print onload='this.media="all",this.onload=null' crossorigin><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js integrity=sha384-VQ8d8WVFw0yHhCk5E8I86oOhv48xLpnDZx5T9GogA/Y84DcCKWXDmSDfn13bzFZY crossorigin></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin></script>
<script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}]})})</script><script defer src=https://cdn.jsdelivr.net/npm/mermaid@8.14.0/dist/mermaid.min.js integrity=sha384-atOyb0FxAgN9LyAc6PEf9BjgwLISyansgdH8/VXQH8p2o5vfrRgmGIJ2Sg22L0A0 crossorigin></script>
<link rel=icon type=image/png sizes=32x32 href=https://alpharivs.github.io/images/icon_hu4bae09c78eba04c5e7d71d1040233379_73006_32x32_fill_q75_box_center.jpg><link rel=apple-touch-icon sizes=180x180 href=https://alpharivs.github.io/images/icon_hu4bae09c78eba04c5e7d71d1040233379_73006_180x180_fill_q75_box_center.jpg><meta name=description content="Write-up for T8 Flare-on 2022 challenge"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://alpharivs.github.io/writeups/"},{"@type":"ListItem","position":2,"name":"Flare-On 2022 - T8","item":"https://alpharivs.github.io/writeups/challenge_teight/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://alpharivs.github.io/writeups/challenge_teight/"},"headline":"Flare-On 2022 - T8 | Lux-Sit","image":"https://alpharivs.github.io/images/writeups/flare.png","datePublished":"2022-11-22T00:00:00+00:00","dateModified":"2022-11-22T00:00:00+00:00","wordCount":1697,"author":{"@type":"Person","name":"Alpharivs"},"publisher":{"@type":"Person","name":"WANG Chucheng","logo":{"@type":"ImageObject","url":"https://alpharivs.github.io/images/icon.jpg"}},"description":"Write-up for T8 Flare-on 2022 challenge"}</script><meta property="og:title" content="Flare-On 2022 - T8 | Lux-Sit"><meta property="og:type" content="article"><meta property="og:image" content="https://alpharivs.github.io/images/icon.jpg"><meta property="og:url" content="https://alpharivs.github.io/writeups/challenge_teight/"><meta property="og:description" content="Write-up for T8 Flare-on 2022 challenge"><meta property="og:locale" content="en"><meta property="og:site_name" content="Lux-Sit"><meta property="article:published_time" content="2022-11-22T00:00:00+00:00"><meta property="article:modified_time" content="2022-11-22T00:00:00+00:00"><meta property="article:section" content="writeups"><meta property="article:tag" content="reversing"><meta property="article:tag" content="static"><meta property="article:tag" content="dynamic"><meta property="article:tag" content="challenge"><meta property="article:tag" content="ctf"><meta property="article:tag" content="flare-on"><meta property="og:see_also" content="https://alpharivs.github.io/writeups/darn_mice/"><meta property="og:see_also" content="https://alpharivs.github.io/writeups/magic_8_ball/"><meta property="og:see_also" content="https://alpharivs.github.io/writeups/flare_flaredle/"><meta property="og:see_also" content="https://alpharivs.github.io/writeups/flare_pixelpoker/"><meta property="og:see_also" content="https://alpharivs.github.io/malware/wannacry/launcher/"><meta property="og:see_also" content="https://alpharivs.github.io/malware/wannacry/dropper/"><body class="flex min-h-screen flex-col"><header class="min-h-16 pl-scrollbar bg-secondary-bg fixed z-50 flex w-full items-center shadow-sm"><div class="mx-auto w-full max-w-screen-xl"><script>let storageColorScheme=localStorage.getItem("lightDarkMode");((storageColorScheme=="Auto"||storageColorScheme==null)&&window.matchMedia("(prefers-color-scheme: dark)").matches||storageColorScheme=="Dark")&&document.getElementsByTagName("html")[0].classList.add("dark")</script><nav class="flex items-center justify-between flex-wrap px-4 py-4 md:py-0"><a href=/ class="me-6 text-primary-text text-xl font-bold">Lux-Sit</a>
<button id=navbar-btn class="md:hidden flex items-center px-3 py-2" aria-label="Open Navbar">
<i class="fas fa-bars"></i></button><div id=target class="hidden block md:flex md:grow md:justify-between md:items-center w-full md:w-auto text-primary-text z-20"><div class="md:flex md:h-16 text-sm md:grow pb-4 md:pb-0 border-b md:border-b-0"><a href=/malware/ class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 border-transparent me-4">Malware Analysis</a>
<a href=/writeups/ class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 selected-menu-item me-4">CTF Write-ups</a>
<a href=/htb_writeups/ class="block mt-4 md:inline-block md:mt-0 md:h-(16-4px) md:leading-(16-4px) box-border md:border-t-2 md:border-b-2 border-transparent me-4">HacktheBox Write-ups</a></div><div class=flex><div class="relative pt-4 md:pt-0"><div class="cursor-pointer hover:text-eureka" id=lightDarkMode><i class="fas fa-adjust"></i></div><div class="fixed hidden inset-0 opacity-0 h-full w-full cursor-default z-30" id=is-open></div><div class="absolute flex flex-col start-0 md:start-auto end-auto md:end-0 hidden bg-secondary-bg w-48 rounded py-2 border border-tertiary-bg cursor-pointer z-40" id=lightDarkOptions><span class="px-4 py-1 hover:text-eureka" name=Light>Light</span>
<span class="px-4 py-1 hover:text-eureka" name=Dark>Dark</span>
<span class="px-4 py-1 hover:text-eureka" name=Auto>Auto</span></div></div></div></div><div class="fixed hidden inset-0 opacity-0 h-full w-full cursor-default z-0" id=is-open-mobile></div></nav><script>let element=document.getElementById("lightDarkMode");storageColorScheme==null||storageColorScheme=="Auto"?document.addEventListener("DOMContentLoaded",()=>{window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",switchDarkMode)}):storageColorScheme=="Light"?(element.firstElementChild.classList.remove("fa-adjust"),element.firstElementChild.setAttribute("data-icon","sun"),element.firstElementChild.classList.add("fa-sun")):storageColorScheme=="Dark"&&(element.firstElementChild.classList.remove("fa-adjust"),element.firstElementChild.setAttribute("data-icon","moon"),element.firstElementChild.classList.add("fa-moon")),document.addEventListener("DOMContentLoaded",()=>{getcolorscheme(),switchBurger()})</script></div></header><main class="grow pt-16"><div class=pl-scrollbar><div class="mx-auto w-full max-w-screen-xl lg:px-4 xl:px-8"><div class="grid grid-cols-2 gap-4 lg:grid-cols-8 lg:pt-12"><div class="bg-secondary-bg col-span-2 rounded px-6 py-8 lg:col-span-6"><article class=prose><h1 class=mb-4>Flare-On 2022 - T8</h1><div class="text-tertiary-text not-prose mt-2 flex flex-row flex-wrap items-center"><div class="me-6 my-2"><i class="fas fa-calendar me-1"></i>
<span>2022-11-22</span></div><div class="me-6 my-2"><i class="fas fa-clock me-1"></i>
<span>8 min read</span></div><div class="me-6 my-2"><i class="fas fa-folder me-1"></i>
<a href=https://alpharivs.github.io/categories/write-ups/ class=hover:text-eureka>write-ups</a></div></div><img src=https://alpharivs.github.io/images/writeups/flare.png class=w-full alt="Featured Image"><h2 id=challenge-description>Challenge Description</h2><pre><code class=language-text>FLARE FACT #823: Studies show that C++ Reversers have fewer friends on average than normal people do. That’s why you’re here, reversing this, instead of with them, because they don’t exist.

We’ve found an unknown executable on one of our hosts. The file has been there for a while, but our networking logs only show suspicious traffic on one day. Can you tell us what happened?
</code></pre><h2 id=challenge-overview>Challenge Overview</h2><p>We are given a Windows PE32 executable.</p><pre><code class=language-bash>+------------------------+------------------------------------------------------------------------------------+
| md5                    | ece22f965b73135469a29a15ae978fb8                                                   |
| sha1                   | 2fd7acefe6c1d258a5666f2b33e123af2eecab50                                           |
| sha256                 | 892a46d456d3ac2d4b406728b0b15dc40450c03bc40af03fd3c510f52eb6f3f7                   |
| os                     | windows                                                                            |
| format                 | pe                                                                                 |
| arch                   | i386                                                                               |
| path                   | t8.exe                                                                             |
+------------------------+------------------------------------------------------------------------------------+
</code></pre><p>And a .pcap file.</p><pre><code class=language-bash>traffic.pcapng: pcapng capture file - version 1.0
</code></pre><h2 id=basic-analysis>Basic Analysis.</h2><h3 id=functionality>Functionality</h3><p>We can use capa to get a quick overview of the executable&rsquo;s capabilities.</p><pre><code class=language-bash>+------------------------------------------------------+------------------------------------------------------+
| CAPABILITY                                           | NAMESPACE                                            |
|------------------------------------------------------+------------------------------------------------------|
| get geographical location                            | collection                                           |
| initialize WinHTTP library                           | communication/http                                   |
| prepare HTTP request                                 | communication/http/client                            |
| receive HTTP response                                | communication/http/client                            |
| encode data using Base64 (2 matches)                 | data-manipulation/encoding/base64                    |
| reference Base64 string                              | data-manipulation/encoding/base64                    |
| encode data using XOR                                | data-manipulation/encoding/xor                       |
| encrypt data using RC4 KSA                           | data-manipulation/encryption/rc4                     |
| encrypt data using RC4 PRGA                          | data-manipulation/encryption/rc4                     |
| hash data with MD5                                   | data-manipulation/hashing/md5                        |
| contain a resource (.rsrc) section                   | executable/pe/section/rsrc                           |
| print debug messages (2 matches)                     | host-interaction/log/debug/write-event               |
| allocate RWX memory                                  | host-interaction/process/inject                      |
+------------------------------------------------------+------------------------------------------------------+
</code></pre><p>That gives us a quick overview of the executable&rsquo;s functionality which includes communication, encoding and encryption.</p><h3 id=imports>Imports</h3><p>Looking at the imports we see potential anti-debugging techniques among other interesting functions that give us a bigger picture of the functionality of the exe.</p><pre><code class=language-bash>KERNEL32.dll - Sleep
KERNEL32.dll - OutputDebugStringW   # Can be used as an anti-debugging technique.
KERNEL32.dll - CreateFileW
KERNEL32.dll - GetModuleHandleW   # Can be used to locate and modify code in a loaded module.
KERNEL32.dll - GetProcAddress   # Retrieves the address of a function in a DLL loaded into memory.
KERNEL32.dll - IsDebuggerPresent  # Can be used as an anti-debugging technique but often added by the compiler.
KERNEL32.dll - GetStartupInfoW  # Retrieves a structure containing details about how the current process was configured to run.
KERNEL32.dll - QueryPerformanceCounter  # Can be used as an anti-debugging technique.
KERNEL32.dll - LoadLibraryExW   # Dynamically loads a DLL.
KERNEL32.dll - WriteFile
KERNEL32.dll - FindFirstFileExW   # Searches through a directory.
KERNEL32.dll - FindNextFileW   # Searches through a directory.
</code></pre><p>And we can confirm what capa already showed us, that the malware imports libraries needed for communication vie http.</p><pre><code class=language-text>WINHTTP.dll - WinHttpReceiveResponse
WINHTTP.dll - WinHttpOpen
WINHTTP.dll - WinHttpReadData
WINHTTP.dll - WinHttpOpenRequest
WINHTTP.dll - WinHttpCloseHandle
WINHTTP.dll - WinHttpSendRequest
WINHTTP.dll - WinHttpConnect

urlmon.dll  - ObtainUserAgentString - Retrieves the User-Agent HTTP request header string that is currently being used.
</code></pre><h3 id=strings>Strings</h3><p>Using Floss we find a few interesting strings.</p><pre><code class=language-bash># Standard Base64 string
ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/
ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_
Input is not valid base64-encoded data.

# Lot's of mangled function names typical of C++ code.
.?AVCClientSock@@

# A domain name.
flare-on.com
</code></pre><h3 id=pcap-file>Pcap File.</h3><p>The pcap file contains two HTTP Post Requests with their respective responses which contain what seems to be a b64 encoded body.</p><p><img src=images/pcap.png alt=pcap></p><p>Decoding the b64 strings doesn&rsquo;t yield any useful data.</p><h2 id=behavior>Behavior</h2><p>When running the executable in our Windows VM there are no suspicious run-time activities, there&rsquo;s no network traffic produced nor procmon detected anything out of the ordinary.</p><p>We know that it produces traffic so there&rsquo;s something going on, the quickest way to determine the issue is using x32dbg.</p><h3 id=anti-debugging-bypass>Anti-Debugging Bypass</h3><p>When running the program with a debugger the program makes a call to the &ldquo;sleep&rdquo; function and then just &mldr; sleeps&mldr; for 12 hours&mldr;
<img src=images/sleep.png alt=sleep></p><p>The result of function <em><strong>C346CA</strong></em> (Note: the address may vary in your machine) is compared to <em><strong>0xF</strong></em> since in out case it&rsquo;s not we don&rsquo;t take the jump and proceed to call the <em><strong>sleep</strong></em> function.</p><p>We could try to reverse function <em><strong>C346CA</strong></em> and see how we can make the comparison to be equal but another option (really lazy but efficient) is to just to patch the instruction to be jump if not <em><strong>0xF</strong></em>.
<img src=images/patch.png alt=patch></p><h2 id=network-traffic-analysis>Network Traffic Analysis</h2><p>Now after setting up our network with <em><strong>inetsim</strong></em> , <em><strong>fakedns</strong></em> and <em><strong>Wireshark</strong></em> we can see network activity.</p><pre><code class=language-bash>remnux@remnux:~$ fakedns
fakedns[INFO]: Response: flare-on.com -&gt; 10.10.10.2
</code></pre><pre><code class=language-bash>[2022-11-23 09:57:33] [1742] [http_80_tcp 1847] [10.10.10.4:4433] recv: Content-Length: 24
[2022-11-23 09:57:33] [1742] [http_80_tcp 1847] [10.10.10.4:4433] recv: Host: flare-on.com
[2022-11-23 09:57:33] [1742] [http_80_tcp 1847] [10.10.10.4:4433] recv: hn/3bLgsLyI=
...(SNIP)...
</code></pre><p>Wireshark gives more details on the headers.</p><pre><code class=language-bash>POST / HTTP/1.1
Connection: Keep-Alive
User-Agent: Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 6.2; WOW64; Trident/7.0; .NET4.0C; .NET4.0E; .NET CLR 2.0.50727; .NET CLR 3.0.30729; .NET CLR 3.5.30729; 25709)
Content-Length: 24
Host: flare-on.com

h.n./.3.b.L.g.s.L.y.I.=.
</code></pre><p>The User-Agent header seems to append a 5 digit random number,</p><pre><code class=language-bash># Our test
User-Agent: ...(snip)... ; 25709)

# .pcap file
User-Agent: ...(snip)... ; 11950)
</code></pre><p>For now we will just take note as it could be some sort of C2 communication.</p><h2 id=advanced-static-analysis>Advanced Static Analysis</h2><p>As we are analyzing a C++ executable there are plenty of things that can complicate our analysis like virtual functions, so a good place to start is using the output of capa with the &lsquo;-v&rsquo; argument to identify where each capability of the executable is located.</p><pre><code class=language-bash>encode data using Base64 (2 matches)
namespace  data-manipulation/encoding/base64
scope      function
matches    0x4014C0
           0x401D90
</code></pre><p>Using this process and following the references we find a vftable of the CClientSock class we can identify the important functionalities of each function in the vftable and label them.</p><p><img src=images/vtable.png alt=vftable></p><p>Now that we know the location of each important function we can analyze them with x32dbg.</p><h2 id=advanced-dynamic-analysis>Advanced Dynamic Analysis</h2><p>We will begin by setting breakpoints in the addresses that <em><strong>capa</strong></em> gave us and analyzing the functions responsible for the base64, MD5 and RC4 encryption using x32dbg, fakeDNS and inetsim.</p><h3 id=base64>Base64</h3><h4 id=0x4014c0>0x4014c0</h4><p>Using &ldquo;Run til return&rdquo; we can see the following value in EAX, it&rsquo;s the same that is sent to us in the POST request.
<img src=images/b64_send.png alt=b64_send></p><h4 id=0x401d90>0x401d90</h4><p>The return value of this function is the body of our response to the POST request.
<img src=images/b64_rcv.png alt=b64_sent></p><p>We confirm that the executable is expecting to receive b64 data.</p><h3 id=md5>MD5</h3><p>We can identify a string passed as an argument.
<img src=images/md5.png alt=md5></p><p>and a MD5 hash as return value.
<img src=images/md5_ret.png alt=md5_ret></p><p>The hash is the MD5 hash of the string passed as argument.</p><pre><code class=language-bash>echo -n &quot;FO918985&quot; | iconv -f ascii -t utf-16le | md5sum
07963e27afe4d167f408122519ac19c2
</code></pre><p>After testing multiple times we can observe that the value being hashed is composed of <em><strong>FO9</strong></em> concatenated with a random number.</p><h3 id=rc4>RC4</h3><h4 id=ksa>KSA</h4><p>We can see the previously generated MD5 hash as an argument (NOTE: the image below shows a different hash because it changes with every run).
<img src=images/rc4_ksa.png alt=rc4_ksa></p><p>This is probably used as passphrase.</p><h4 id=prga>PRGA</h4><p>We can identify the string <em><strong>ahoy</strong></em> as an argument.
<img src=images/rc4_prga.png alt=rc4_prga></p><h4 id=testing-decryption>Testing Decryption</h4><p>Having received the following POST request:</p><pre><code class=language-bash>POST / HTTP/1.1
Connection: Keep-Alive
User-Agent: Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 6.2; WOW64; Trident/7.0; .NET4.0C; .NET4.0E; .NET CLR 2.0.50727; .NET CLR 3.0.30729; .NET CLR 3.5.30729; 9360)
Content-Length: 24
Host: flare-on.com

Z.7.h.i.3.+.V.j.g.I.A.=.
</code></pre><p>We can test if it can be decrypted using the information that we now know and it works!.
<img src=images/dec_test.png alt=dec_test></p><p>We can replicate the hash used in the POST request found in the .pcap file that we were given.</p><pre><code class=language-bash>echo -n &quot;FO911950&quot; | iconv -f ascii -t utf-16le | md5sum
a5c6993299429aa7b900211d4a279848
</code></pre><p>It also works to decrypt the POST message:</p><p><img src=images/dec_req.png alt=dec_req></p><p>But decrypting the response doesn&rsquo;t give us any usable data.</p><h2 id=faking-the-server>Faking the Server</h2><p>We know that the executable expects a b64 response so let&rsquo;s try replicating the same b64 response that is present in the .pcap file using any of the following methods.</p><ul><li>FakeDNS + InetSim</li></ul><p>NOTE: if using inetsim to create a .html response with Vim it is necessary to run the following commands in Vim:</p><pre><code class=language-bash>:set binary
:set noeol
:wq
</code></pre><ul><li>FakeDNS + Flask</li></ul><p>Alternatively we could use a simple Flask server.</p><pre><code class=language-python>from flask import Flask
from flask import request

app = Flask(__name__)

@app.route(&quot;/&quot;, methods=[&quot;GET&quot;,&quot;POST&quot;])
def c2():
    ua = request.headers.get('User-Agent')
    print(ua)
    print(&quot;Sending Response&quot;)

    r =  &quot;TdQdBRa1nxGU06dbB27E7SQ7TJ2+cd7zstLXRQcLbmh2nTvDm1p5IfT/Cu0JxShk6tHQBRWwPlo9zA1dISfslkLgGDs41WK12ibWIflqLE4Yq3OYIEnLNjwVHrjL2U4Lu3ms+HQc4nfMWXPgcOHb4fhokk93/AJd5GTuC5z+4YsmgRh1Z90yinLBKB+fmGUyagT6gon/KHmJdvAOQ8nAnl8K/0XG+8zYQbZRwgY6tHvvpfyn9OXCyuct5/cOi8KWgALvVHQWafrp8qB/JtT+t5zmnezQlp3zPL4sj2CJfcUTK5copbZCyHexVD4jJN+LezJEtrDXP1DJNg==&quot;
    return r

app.run(host='', port=80, threaded=True)
</code></pre><h3 id=decrypting-the-response>Decrypting the Response</h3><p>We will set breakpoints in the <em><strong>RC4 KSA</strong></em> and <em><strong>RC4 PRGA</strong></em> functions taking notice that data from our server is not received until the <em><strong>second</strong></em> hit to the <em><strong>RC4 KSA</strong></em> breakpoint.</p><p>Then we do the following:</p><ul><li>1 - Hit the RC4 KSA breakpoint (the second time).</li><li>2 - Follow in dump the argument containing the hash.</li><li>3 - Select the hash in the dump window, right click > binary > edit.</li><li>4 - Edit the key to be the one that we reconstructed from the .pcap POST (<em><strong>a5c6993299429aa7b900211d4a279848</strong></em>)
<img src=images/key_mod.png alt=key_mod></li></ul><p>Then when the program hits the RC4 PRGA breakpoint we can dump the second argument.
<img src=images/pcap_recv.png alt=pcap_recv></p><p>We can compare it to the data from the .pcap file and see that it&rsquo;t the same data.</p><pre><code class=language-python>echo &quot;TdQdBRa1nxGU06dbB27E7SQ7TJ2+cd7zstLXRQcLbmh2nTvDm1p5IfT/Cu0JxShk6tHQBRWwPlo9zA1dISfslkLgGDs41WK12ibWIflqLE4Yq3OYIEnLNjwVHrjL2U4Lu3ms+HQc4nfMWXPgcOHb4fhokk93/AJd5GTuC5z+4YsmgRh1Z90yinLBKB+fmGUyagT6gon/KHmJdvAOQ8nAnl8K/0XG+8zYQbZRwgY6tHvvpfyn9OXCyuct5/cOi8KWgALvVHQWafrp8qB/JtT+t5zmnezQlp3zPL4sj2CJfcUTK5copbZCyHexVD4jJN+LezJEtrDXP1DJNg==&quot; | base64 -d | xxd

00000000: 4dd4 1d05 16b5 9f11 94d3 a75b 076e c4ed  M..........[.n..
00000010: 243b 4c9d be71 def3 b2d2 d745 070b 6e68  $;L..q.....E..nh
00000020: 769d 3bc3 9b5a 7921 f4ff 0aed 09c5 2864  v.;..Zy!......(d
00000030: ead1 d005 15b0 3e5a 3dcc 0d5d 2127 ec96  ......&gt;Z=..]!'..
00000040: 42e0 183b 38d5 62b5 da26 d621 f96a 2c4e  B..;8.b..&amp;.!.j,N
00000050: 18ab 7398 2049 cb36 3c15 1eb8 cbd9 4e0b  ..s. I.6&lt;.....N.
...(SNIP)...
</code></pre><p>That confirms that we have indeed sent the correct data to the executable.</p><h2 id=flag>Flag</h2><h3 id=tracing-the-vftable-calls-in-main>Tracing the vftable calls in main.</h3><p>Now that we know that we are capable of decrypting the data we need to understand the flow of the program to see where that data goes.</p><p>After analyzing the main function we can trace how it&rsquo;s calling the vftable functions and whe can find the following:</p><p><img src=images/flow1.png alt=flow1></p><p>Those vftable calls point at function 403860 (<em><strong>RC4</strong></em>) and 403D70 (<em><strong>HTTP</strong></em>) respectively that checks out with the behavior that we know, the next vftable function to be called is the following:</p><p><img src=images/flow2.png alt=flow2></p><p>Offset 8 of the vftable is points to the function 404200 contains calls to <em><strong>_wcstok_s</strong></em> so it&rsquo;s doing some string manipulation, we can just set a breakpoint at it&rsquo;s return instruction and see what value it yields.</p><p><img src=images/200_ret.png alt=200_ret></p><h3 id=full-flag>Full Flag</h3><p>If we continue debugging we eventually go back to the main function where the string is concatenated with <em><strong>@flare-on.com</strong></em>.</p><p><img src=images/final_form.png alt=final_form></p><p>That gives us the full flag!</p><p>Lux-Sit</p><p>P.S: God I hate reversing C++ &mldr;</p></article><div class=my-4><a href=https://alpharivs.github.io/tags/reversing/ class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 me-2 hover:text-eureka">#reversing</a>
<a href=https://alpharivs.github.io/tags/static/ class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 me-2 hover:text-eureka">#static</a>
<a href=https://alpharivs.github.io/tags/dynamic/ class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 me-2 hover:text-eureka">#dynamic</a>
<a href=https://alpharivs.github.io/tags/challenge/ class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 me-2 hover:text-eureka">#challenge</a>
<a href=https://alpharivs.github.io/tags/ctf/ class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 me-2 hover:text-eureka">#ctf</a>
<a href=https://alpharivs.github.io/tags/flare-on/ class="inline-block bg-tertiary-bg text-sm rounded px-3 py-1 my-1 me-2 hover:text-eureka">#flare-on</a></div><div class=py-2><div class="my-8 flex flex-col items-center md:flex-row"><a href=https://alpharivs.github.io/authors/alpharivs/ class="md:me-4 text-primary-text h-24 w-24"><img src=https://alpharivs.github.io/images/profile.jpg class="bg-primary-bg w-full rounded-full" alt=Avatar></a><div class="mt-4 w-full md:mt-0 md:w-auto"><a href=https://alpharivs.github.io/authors/alpharivs/ class="mb-2 block border-b pb-1 text-lg font-bold"><h3>Alpharivs</h3></a><span class="block pb-2">Eternal Cybersecurity student with love for Malware and CTFs</span>
<a href=mailto:caliburn@tutanota.de class=me-2><i class="fas fa-envelope"></i></a>
<a href=https://twitter.com/alpharivs class=me-2><i class="fab fa-twitter"></i></a>
<a href=https://github.com/Alpharivs class=me-2><i class="fab fa-github"></i></a>
<a href=https://app.hackthebox.com/users/525385 class=me-2><i class="fab fa-jedi-order"></i></a></div></div></div><div class="-mx-2 mt-4 flex flex-col border-t px-2 pt-4 md:flex-row md:justify-between"><div></div><div class="mt-4 md:mt-0 md:text-right"><span class="text-primary-text block font-bold">Next</span>
<a href=https://alpharivs.github.io/writeups/darn_mice/ class=block>Flare-On 2022 - darn_mice</a></div></div></div><div class=col-span-2><div class="bg-primary-bg
prose sticky top-16 z-10 hidden px-6 py-4 lg:block"><h3>On This Page</h3></div><div class="sticky-toc hidden px-6 pb-6 lg:block"><nav id=TableOfContents><ul><li><a href=#challenge-description>Challenge Description</a></li><li><a href=#challenge-overview>Challenge Overview</a></li><li><a href=#basic-analysis>Basic Analysis.</a><ul><li><a href=#functionality>Functionality</a></li><li><a href=#imports>Imports</a></li><li><a href=#strings>Strings</a></li><li><a href=#pcap-file>Pcap File.</a></li></ul></li><li><a href=#behavior>Behavior</a><ul><li><a href=#anti-debugging-bypass>Anti-Debugging Bypass</a></li></ul></li><li><a href=#network-traffic-analysis>Network Traffic Analysis</a></li><li><a href=#advanced-static-analysis>Advanced Static Analysis</a></li><li><a href=#advanced-dynamic-analysis>Advanced Dynamic Analysis</a><ul><li><a href=#base64>Base64</a><ul><li><a href=#0x4014c0>0x4014c0</a></li><li><a href=#0x401d90>0x401d90</a></li></ul></li><li><a href=#md5>MD5</a></li><li><a href=#rc4>RC4</a><ul><li><a href=#ksa>KSA</a></li><li><a href=#prga>PRGA</a></li><li><a href=#testing-decryption>Testing Decryption</a></li></ul></li></ul></li><li><a href=#faking-the-server>Faking the Server</a><ul><li><a href=#decrypting-the-response>Decrypting the Response</a></li></ul></li><li><a href=#flag>Flag</a><ul><li><a href=#tracing-the-vftable-calls-in-main>Tracing the vftable calls in main.</a></li><li><a href=#full-flag>Full Flag</a></li></ul></li></ul></nav></div><script>window.addEventListener("DOMContentLoaded",()=>{enableStickyToc()})</script></div><div class="bg-secondary-bg prose col-span-2 rounded p-6 lg:col-span-6"><h3>See Also</h3><a href=https://alpharivs.github.io/writeups/darn_mice/ class=no-underline>Flare-On 2022 - darn_mice</a><br><a href=https://alpharivs.github.io/writeups/magic_8_ball/ class=no-underline>Flare-On 2022 - Magic 8 Ball</a><br><a href=https://alpharivs.github.io/writeups/flare_flaredle/ class=no-underline>Flare-On 2022 - Flaredle</a><br><a href=https://alpharivs.github.io/writeups/flare_pixelpoker/ class=no-underline>Flare-On 2022 - Pixel Poker</a><br><a href=https://alpharivs.github.io/malware/wannacry/launcher/ class=no-underline>Wannacry - Part 2</a><br><a href=https://alpharivs.github.io/malware/wannacry/dropper/ class=no-underline>Wannacry - Part 1</a><br></div></div><script>document.addEventListener("DOMContentLoaded",()=>{hljs.highlightAll()})</script></div></div></main><footer class=pl-scrollbar><div class="mx-auto w-full max-w-screen-xl"><div class="text-center p-6 pin-b"><p class="text-sm text-tertiary-text">&copy; 2022 <a href=https://twitter.com/alpharivs>Alpharivs</a>
&#183; Powered by the <a href=https://github.com/wangchucheng/hugo-eureka class=hover:text-eureka>Eureka</a> theme for <a href=https://gohugo.io class=hover:text-eureka>Hugo</a></p></div></div></footer></body></html>